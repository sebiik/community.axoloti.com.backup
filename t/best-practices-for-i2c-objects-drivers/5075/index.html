<!DOCTYPE html>
<html lang="en" class="desktop-view not-mobile-device  anon">
  <head>
    <meta charset="utf-8">
    <title>Best Practices for I2C Objects/Drivers - AxoObject coding - Axoloti Community</title>
    <meta name="description" content="@SmashedTransistors wrote: 

Maybe it is a good idea to start a new thread about &amp;quot;tips and good practices for I2C objects&amp;quot;. 

Here&amp;#39;s my take on writing I2C drivers for Axoloti. Feel free to comment/contribute. 

Introduc&amp;hellip;">
    <meta name="discourse_theme_key" content="b5ce34aa-3ee1-4d3e-b190-0a2ab62c7408">
    <meta name="author" content="">
<meta name="generator" content="Discourse 1.9.0.beta3 - https://github.com/discourse/discourse version 13f3de4bf673802eb8ec595d36587b4524773209">
<link rel="icon" type="image/png" href="/uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<link rel="apple-touch-icon" type="image/png" href="/uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<link rel="icon" sizes="144x144" href="/uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<link rel="canonical" href="http://community.axoloti.com/t/best-practices-for-i2c-objects-drivers/5075" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"http://community.axoloti.com","potentialAction":{"@type":"SearchAction","target":"http://community.axoloti.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="http://community.axoloti.com/opensearch.xml" title="Axoloti Community Search">

    

      <meta name="fragment" content="!">


    <script>
      window.EmberENV = window.EmberENV || {};
      window.EmberENV['FORCE_JQUERY'] = true;
    </script>

    <link rel='preload' href='/assets/locales/en-5bbc8626277bd471a9fcd063411070c515cad1a78c86a38ad27792a513f11bd4.js' as='script'/>
<script src='/assets/locales/en-5bbc8626277bd471a9fcd063411070c515cad1a78c86a38ad27792a513f11bd4.js'></script>
    <link rel='preload' href='/assets/ember_jquery-a8dcbd325e04410f036f2a791d66d8316c48c5387acdd914de99a5dd6afb3cd3.js' as='script'/>
<script src='/assets/ember_jquery-a8dcbd325e04410f036f2a791d66d8316c48c5387acdd914de99a5dd6afb3cd3.js'></script>
    <link rel='preload' href='/assets/preload-store-ec90ffab9d7a6d9e507dda7cf7343e9d50b8bce624f7f44486ac8fd6b9814309.js' as='script'/>
<script src='/assets/preload-store-ec90ffab9d7a6d9e507dda7cf7343e9d50b8bce624f7f44486ac8fd6b9814309.js'></script>
    <link rel='preload' href='/assets/vendor-199fce5a9e9895329b51b04605f1f5061951acb488baa6b2ea2fc2ae36def529.js' as='script'/>
<script src='/assets/vendor-199fce5a9e9895329b51b04605f1f5061951acb488baa6b2ea2fc2ae36def529.js'></script>
    <link rel='preload' href='/assets/pretty-text-bundle-e888dd08c05658b05da2124dd56955aa8fe94225d532fb8bfa3264a3eb2aa581.js' as='script'/>
<script src='/assets/pretty-text-bundle-e888dd08c05658b05da2124dd56955aa8fe94225d532fb8bfa3264a3eb2aa581.js'></script>
    <link rel='preload' href='/assets/application-13a284a273d9247cd8b3d19ae7d053297aeb5b3eabaa9a901c9fd236fb7dfe60.js' as='script'/>
<script src='/assets/application-13a284a273d9247cd8b3d19ae7d053297aeb5b3eabaa9a901c9fd236fb7dfe60.js'></script>
    <link rel='preload' href='/assets/plugin-3a5d56cbe920ebb10de8abd59e839cf2d48d598ca07a267327f96e3fec534065.js' as='script'/>
<script src='/assets/plugin-3a5d56cbe920ebb10de8abd59e839cf2d48d598ca07a267327f96e3fec534065.js'></script>
    <link rel='preload' href='/assets/plugin-third-party-346f0166b34a16f0ac66ea388d925068ee8f76267dc167ac7173785ea046f465.js' as='script'/>
<script src='/assets/plugin-third-party-346f0166b34a16f0ac66ea388d925068ee8f76267dc167ac7173785ea046f465.js'></script>


      

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56017691-4', {"cookieDomain":"auto"});
</script>

    <link rel="manifest" href="/manifest.json">


      <link href="/stylesheets/desktop_d93a33ca8617326fe353f80e6ab865188244d48c.css?__ws=community.axoloti.com" media="all" rel="stylesheet" data-target="desktop"/>


  <link href="/stylesheets/desktop_theme_1_6c5f8f7f5e6a154a9f0dfd7aedf04bae4b669f17.css?__ws=community.axoloti.com" media="all" rel="stylesheet" data-target="desktop_theme"/>

    

<link rel="preload" href="/assets/fontawesome-webfont-2adefcbc041e7d18fcf2d417879dc5a09997aa64d675b7a3c4b6ce33da13f3fe.woff2?http://community.axoloti.com&2&v=4.7.0" as="font" type="font/woff2" crossorigin />
<style>
  @font-face {
    font-family: 'FontAwesome';
    src: url('/assets/fontawesome-webfont-2adefcbc041e7d18fcf2d417879dc5a09997aa64d675b7a3c4b6ce33da13f3fe.woff2?http://community.axoloti.com&2&v=4.7.0') format('woff2'),
         url('/assets/fontawesome-webfont-ba0c59deb5450f5cb41b3f93609ee2d0d995415877ddfa223e8a8a7533474f07.woff?http://community.axoloti.com&amp;2&v=4.7.0') format('woff');
  }
</style>


      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Best Practices for I2C Objects/Drivers&#39;" href="http://community.axoloti.com/t/best-practices-for-i2c-objects-drivers/5075.rss" />
  <meta property="og:site_name" content="Axoloti Community" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="http://community.axoloti.com/uploads/default/original/2X/b/b06df6b64f4e7280e5bcba6611bca0567cfbb537.png" />
<meta property="og:image" content="http://community.axoloti.com/uploads/default/original/2X/b/b06df6b64f4e7280e5bcba6611bca0567cfbb537.png" />
<meta property="og:url" content="http://community.axoloti.com/t/best-practices-for-i2c-objects-drivers/5075" />
<meta name="twitter:url" content="http://community.axoloti.com/t/best-practices-for-i2c-objects-drivers/5075" />
<meta property="og:title" content="Best Practices for I2C Objects/Drivers" />
<meta name="twitter:title" content="Best Practices for I2C Objects/Drivers" />
<meta property="og:description" content="@SmashedTransistors wrote:   Maybe it is a good idea to start a new thread about &quot;tips and good practices for I2C objects&quot;.   Here&#39;s my take on writing I2C drivers for Axoloti. Feel free to comment/contribute.   Introduction  I2C is a shared bus technology. i2c wikipedia   Lot&#39;s of interesting chips have an I2C interface and the Axoloti provides an I2C bus on the IO pins. If you have a new I2C device you want to hook up, you&#39;ll need to write an I2C driver/object for it.   I2C is a shared bus.   T..." />
<meta name="twitter:description" content="@SmashedTransistors wrote:   Maybe it is a good idea to start a new thread about &quot;tips and good practices for I2C objects&quot;.   Here&#39;s my take on writing I2C drivers for Axoloti. Feel free to comment/contribute.   Introduction  I2C is a shared bus technology. i2c wikipedia   Lot&#39;s of interesting chips have an I2C interface and the Axoloti provides an I2C bus on the IO pins. If you have a new I2C device you want to hook up, you&#39;ll need to write an I2C driver/object for it.   I2C is a shared bus.   T..." />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="4 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="7 ❤" />



    
  </head>

  <body class="">
    

    <div class='debug-eyeline'></div>

    <noscript data-path="/t/best-practices-for-i2c-objects-drivers/5075">
      <header class="d-header">
  <div class="wrap">
    <div class="contents">
      <div class="row">
        <div class="title span13">
          <a href="/">
              <img src="/uploads/default/original/1X/b22e6e9ef608f1e17a1de19b733d043beff77f05.png" alt="Axoloti Community" id="site-logo">
          </a>
        </div>
            <div class='panel clearfix'>
              <a href="/login" class='btn btn-primary btn-small login-button'><i class="fa fa-user"></i> Log In</a>
            </div>
      </div>
    </div>
  </div>
</header>

      <div id="main-outlet" class="wrap">
        <!-- preload-content: -->
        <h1>
  <a href="/t/best-practices-for-i2c-objects-drivers/5075">Best Practices for I2C Objects/Drivers</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="/c/axoobject-code" itemprop="url">
        <span itemprop="title">AxoObject coding</span>
      </a>
    </div>
</div>





<hr>


  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='/u/deadsy'><b itemprop='author'>deadsy</b></a>
           
           <time datetime='2018-10-20T17:18:08Z' itemprop='datePublished'>
             2018-10-20 17:18:08 UTC
           </time>
        </span>
        <span itemprop='position'>#1</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p><a class="mention" href="/u/smashedtransistors">@SmashedTransistors</a> wrote:</p>

<blockquote><p>Maybe it is a good idea to start a new thread about "tips and good practices for I2C objects".</p></blockquote>

<p>Here's my take on writing I2C drivers for Axoloti. Feel free to comment/contribute.</p>

<h2>Introduction</h2>

<p>I2C is a shared bus technology.<br><a href="https://en.wikipedia.org/wiki/I%C2%B2C" rel="nofollow noopener">i2c wikipedia</a></p>

<p>Lot's of interesting chips have an I2C interface and the Axoloti provides an I2C bus on the IO pins.<br>If you have a new I2C device you want to hook up, you'll need to write an I2C driver/object for it.</p>

<p>I2C is a <em>shared</em> bus.</p>

<p>The Axoloti is the bus master. Each device is a bus slave. There can be multiple slaves on a single bus (each with a unique 7-bit I2C address). The Axoloti initiates a bus transaction (read/write) and the slave device responds. Each device is controlled by it's own driver- which will typically be a patch object.</p>

<p>Here are some best practices to ensure different device drivers work well on the same bus.</p>

<h2>1. Provide a way for the user to specify a unique device address.</h2>

<p>When the master (Axoloti) starts a transaction on the bus, it specifies the device it wants to talk to by using a 7-bit I2C address. The master talks to one device at a time, so each device needs a unique I2C address. The device datasheet will tell you which addresses a specific device can use. The device will often have some pins to customize (with hardware jumpers) some bits of the address. This allows the user to have multiple instances of the same device on the bus, each with a unique address. The driver writer needs to provide a way to specify which device address a driver should be using.</p>

<p>The device address needs to be specified at compile time. On Axoloti this can be handled by an attribute in the object:<br><code><br>&lt;attribs&gt;<br>    &lt;combo name="adr"&gt;<br>      &lt;MenuEntries&gt;<br>          &lt;string&gt;0x1d&lt;/string&gt;<br>          &lt;string&gt;0x53&lt;/string&gt;<br>      &lt;/MenuEntries&gt;<br>      &lt;CEntries&gt;<br>          &lt;string&gt;0x1d&lt;/string&gt;<br>          &lt;string&gt;0x53&lt;/string&gt;<br>      &lt;/CEntries&gt;<br>    &lt;/combo&gt;<br>&lt;/attribs&gt;<br></code></p>

<h2>2. Initialise the I2C bus only once.</h2>

<p>The I2C bus needs to be initialized in the patch. A given patch might control multiple I2C devices, but the I2C bus should only be initialized once. The bus is initialized by a call to the i2cStart() function. This should <em>not</em> be called within the driver because with multiple devices each driver would make a call to initialize the bus. It should be called through a single instance of the i2c config object.<br><code><br>axoloti-factory/objects/gpio/i2c/config.axo<br></code></p>

<p>This object does not connect to anything in the patch, it just handles the IO setup and shutdown for the I2C bus.</p>

<p><img src="//community.axoloti.com/uploads/default/original/2X/b/b06df6b64f4e7280e5bcba6611bca0567cfbb537.png" width="299" height="62"></p>

<h2>3. Allocate I2C Transaction Buffers out of the SRAM2 segment.</h2>

<p>The buffers used to tx/rx bytes from the I2C device need to be in the SRAM2 segment. If we look at the linker script we see:<br><code><br>SRAM2  : org = 0x2001E000, len = 0x00002000 /* second half (8kB) of SRAM2 for DMA*/<br></code></p>

<p>The bytes from memory to the I2C controller are DMA'ed so we need to use memory that can be DMA'ed. In the driver you can specify the segment in which the linker will allocate the storage by using the "attribute" pragma.</p>

<p>Example:<br><code><br>static uint8_t rxbuf[32] __attribute__ ((section(".sram2")));<br></code><br>This is more of a requirement than a best practice. If you don't do it the I2C bus transactions won't work.</p>

<h2>4. Device IO operations should be in their own thread.</h2>

<p>Axoloti uses ChibiOS which is a multi-threaded RTOS. The DSP thread calls the krate/srate functions of the patch and computes the audio. The DSP thread needs to run as quickly as possible so it can feed the codec.<br>The DSP thread should not be waiting for external IO to take place. The I2C bus operations should run in their own thread where they can run asynchronously without slowing down the DSP thread.</p>

<p>Example:</p>

<p>In the init function we create the IO thread:<br><code><br>// create the polling thread<br>s-&gt;thd = chThdCreateStatic(s-&gt;thd_wa, sizeof(s-&gt;thd_wa), NORMALPRIO, adxl345_thread, (void *)s);<br></code><br>And in the dispose function we terminate the thread:<br><code><br>// stop thread<br>chThdTerminate(s-&gt;thd);<br>chThdWait(s-&gt;thd);<br></code></p>

<h2>5. Lock/Unlock the I2C bus around bus operations.</h2>

<p>With each device driver running in its own thread we have multiple threads each trying to access the same I2C bus. The drivers will access the bus asynchronously, so we have to make sure access is properly shared. ChibiOS provides functions to lock/unlock the bus: i2cAcquireBus(), i2cReleaseBus() A given thread needs to get the lock before it uses the bus and release the lock after it has finished with the bus.</p>

<p>Example:<br><code><br>i2cAcquireBus(s-&gt;dev);<br>msg_t rc = i2cMasterReceiveTimeout(s-&gt;dev, s-&gt;adr, s-&gt;rx, 2, TTP229_I2C_TIMEOUT);<br>i2cReleaseBus(s-&gt;dev);<br></code><br>It's up to the driver writer to minimize lock time and not hog the bus. Many devices will be periodically polled/updated. Be a good neighbor. Take a look at the device datasheet and work out how slowly you can poll the device.</p>

<h2>6. Lock shared memory access between DSP and IO threads.</h2>

<p>The device driver IO thread and DSP thread need to communicate. This is typically done with memory shared between the threads. When one thread is writing the data, the other thread should not be reading it, and vice versa. Each thread has to get exclusive access to the shared memory before it reads or write it.</p>

<p>Example:</p>

<p>In the IO Thread:<br><code><br>// write to shared variables<br>chSysLock();<br>s-&gt;x = x;<br>s-&gt;y = y;<br>s-&gt;z = z;<br>chSysUnlock();<br></code></p>

<p>In the DSP Thread:<br><code><br>// read from shared variables<br>chSysLock();<br>x = s-&gt;x;<br>y = s-&gt;y;<br>z = s-&gt;z;<br>chSysUnlock();<br></code></p>

<p>In this example if you don't lock the shared variable access, you will potentially have x,y,z values being mixed up between samples.</p>

<p>Note: Using chSysLock/chSysUnlock is an interrupt disable/enable. This gets the job done, but should only be used for very short lock periods because it stops all threads, not just the one that is contending for the variable access. ChibiOS provides other, more sophisticated, methods for inter thread communication (not all of which are enabled in the standard Axoloti firmware...).</p>

<h2>Driver Examples</h2>

<p>Here are some I2C object/drivers that use the aforementioned practices:</p>

<p><a href="https://github.com/axoloti/axoloti-contrib/tree/1.0.12/objects/deadsy/mpr121" rel="nofollow noopener">mpr121 driver</a></p>

<p><a href="https://github.com/axoloti/axoloti-contrib/tree/1.0.12/objects/deadsy/ttp229" rel="nofollow noopener">ttp229 driver</a></p>

<p>Note:<br>I have an aversion to writing C code in XML files, so the bulk of the driver code for these examples is in the *.h include file. This makes the driver code a bit different from the "all in the axo" form but for either form the best practices still apply.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:7'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Best Practices for I2C Objects/Drivers'>
      <hr>
            <a href="https://sebiik.github.io/community.axoloti.com.backup/t/spi-i2c-oled-display/638/150">SPI/I2C OLED display</a>
            <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='/u/thetechnobear'><b itemprop='author'>thetechnobear</b></a>
           
           <time datetime='2018-10-20T19:00:11Z' itemprop='datePublished'>
             2018-10-20 19:00:11 UTC
           </time>
        </span>
        <span itemprop='position'>#2</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>cool stuff, and a great write up!</p>

<hr>

<p>won't the chSysLock() potentially block the DSP (for a very short while) ?!</p>

<p>what id be tempted to do is use a lock free ring buffer, this is what I did for the (firmware) midi implementation. doesn't have to be a complex implementation if you have a good understanding of the timing of the IO on the I2C - the buffer only has to be big enough to allow for 'some latency/jitter'</p>

<aside class="quote" data-post="1" data-topic="5075"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//community.axoloti.com/user_avatar/community.axoloti.com/deadsy/40/5105_1.png" class="avatar">deadsy:</div>
<blockquote><p>I have an aversion to writing C code in XML files, so the bulk of the driver code for these examples is in the *.h include file. </p></blockquote></aside>

<p>yeah, I do the same for anything that's non-trivial</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='Best Practices for I2C Objects/Drivers'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='/u/deadsy'><b itemprop='author'>deadsy</b></a>
           
           <time datetime='2018-10-21T15:55:01Z' itemprop='datePublished'>
             2018-10-21 15:55:01 UTC
           </time>
        </span>
        <span itemprop='position'>#3</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p><a class="mention" href="/u/thetechnobear">@thetechnobear</a> says:</p>

<blockquote><p>won't the chSysLock() potentially block the DSP</p></blockquote>

<p>Yes - it's turns into a global interrupt disable, so the thread can't be preempted until it has called the unlock.</p>

<p>For something like a touch sensor driver you only need a single uint32 as the result of the sensor read so I think a quick lock/unlock around the shared memory reference is probably about as fast as you can manage.</p>

<p>Someone might say: "You should be using a mutex!"</p>

<p>Check it out:</p>

<pre><code>void chMtxLock(Mutex *mp) {
  chSysLock();
  chMtxLockS(mp);
  chSysUnlock();
}</code></pre>

<p>Still doing a quick global interrupt disable/enable. If you only have to share a single uint32 then the interrupt disable/enable will be faster. It's also worth noting that the DSP thread can't spend its time waiting on any sort of lock. Whatever you do it needs to be quick.</p>

<p>Of course for some drivers (E.g. a keyboard scanner) you may need something more sophisticated like a circular buffer, in which case a the code needs to be more complicated. If you've got the chops to write lock-less code that works properly, more power to you <img src="//community.axoloti.com/images/emoji/twitter/slight_smile.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"> </p>

<p>BTW - ChibiOS has a nice feature called mailboxes.<br><a href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:book:kernel_mailboxes" rel="nofollow noopener">RT mailboxes</a><br>It would be nice to use in drivers, but the feature is not enabled in the standard firmware build. Could we get it enabled for the next release?</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Best Practices for I2C Objects/Drivers'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='/u/thetechnobear'><b itemprop='author'>thetechnobear</b></a>
           
           <time datetime='2018-10-21T18:59:21Z' itemprop='datePublished'>
             2018-10-21 18:59:21 UTC
           </time>
        </span>
        <span itemprop='position'>#4</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>I didn’t say use a mutex, i said use a lock free strategy.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='Best Practices for I2C Objects/Drivers'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='/u/SmashedTransistors'><b itemprop='author'>SmashedTransistors</b></a>
           
           <time datetime='2018-10-21T20:44:58Z' itemprop='datePublished'>
             2018-10-21 20:44:58 UTC
           </time>
        </span>
        <span itemprop='position'>#5</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Would this kind of strategy lead to use of double or triple buffering ?</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='Best Practices for I2C Objects/Drivers'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='/u/deadsy'><b itemprop='author'>deadsy</b></a>
           
           <time datetime='2018-10-23T17:07:55Z' itemprop='datePublished'>
             2018-10-23 17:07:55 UTC
           </time>
        </span>
        <span itemprop='position'>#6</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p><a class="mention" href="/u/thetechnobear">@thetechnobear</a> </p>

<blockquote><p>use a lock free ring buffer, this is what I did for the (firmware) midi implementation. </p></blockquote>

<p>Can you point me to a code reference?<br>I've been looking for telltale strex/ldrex instructions, but I don't see anything in either master or experimental...</p>

<p>Thanks.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Best Practices for I2C Objects/Drivers'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='/u/SmashedTransistors'><b itemprop='author'>SmashedTransistors</b></a>
           
           <time datetime='2018-10-25T00:16:30Z' itemprop='datePublished'>
             2018-10-25 00:16:30 UTC
           </time>
        </span>
        <span itemprop='position'>#7</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Is this related to <a href="https://en.wikipedia.org/wiki/Load-link/store-conditional" rel="nofollow noopener">lock-free atomic read-modify-write operation</a> ? Is it useful in a single core processor ?<br>As I did not had to care about multi-threading on the Axoloti yet, I'm not aware of all the mechanisms available. <br>That's very interesting.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='Best Practices for I2C Objects/Drivers'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='/u/deadsy'><b itemprop='author'>deadsy</b></a>
           
           <time datetime='2018-10-25T01:15:43Z' itemprop='datePublished'>
             2018-10-25 01:15:43 UTC
           </time>
        </span>
        <span itemprop='position'>#8</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p><a class="mention" href="/u/smashedtransistors">@SmashedTransistors</a></p>

<p>Yes - lock free techniques are generally useful on both single core and multi-core devices. ChibiOS has the usual set of semaphores, mutexes, mailboxes, etc. used for data sharing between threads. All of them disable interrupts to lock out other threads and enforce the atomic sharing of data. Lock-less techniques don't lock out other threads, they can still run. The Cortex-M4 ISA provides load exclusive and store exclusive instructions used to implement lock-less data sharing.</p>

<p>Now: I wouldn't consider myself and expert at concurrent programming, and certainly not at lock-less sharing, but from what I understand getting lock-less right is tough. The conservative approach is probably to use the conventional locking primitives and see if that performs well enough. If yes - declare success. If no- then <em>maybe</em> consider lock-less as an optimization.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='Best Practices for I2C Objects/Drivers'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='/u/thetechnobear'><b itemprop='author'>thetechnobear</b></a>
           
           <time datetime='2018-10-25T09:22:33Z' itemprop='datePublished'>
             2018-10-25 09:22:33 UTC
           </time>
        </span>
        <span itemprop='position'>#9</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>yeah doing a proper lock free implementation is complex - but there are lots of freely available versions to use, usually in the form of a ring buffer. (as they also need to not allocate memory) </p>

<p>Ive used them on other limited platforms (rPI/Organelle) to good effect, though ive not reviewed how much 'extra' memory they take , which may or may not be an issue with axoloti.</p>

<hr>

<p>what I did for the midi ring buffer was simply to do it without locks (*), with detection for the read/write pointers crossing. but I was quite careful how I did the implementation, to ensure any theoretical thread contentions are minimised e.g. only writing in one thread - and making sure comparisons were very limited.<br>(so your implementation has to be a bit more considered, than just taking out the locks - I know exactly where the possible thread contention are, how likely (minimal) , and the consequences  ) </p>

<p>theoretically I could have used 'test and set' atomic operations,  but I didn't because it doesn't really matter that much in this use case.<br> if the ring-buffer is overflowing theres little you can do about it... its more than likely that the producer is still going to keep producing at a higher rate than consumer, so known 1 byte before or after doesn't really change the outcome <img src="//community.axoloti.com/images/emoji/twitter/wink.png?v=5" title=":wink:" class="emoji" alt=":wink:"> </p>

<p>basically its an optimistic strategy, where due to the ring buffer size, really it should not fail, and if it does its not the end of the world. ideally we would allow the user to optionally configure the ring buffer size, based on their needs.</p>

<hr>

<p>in this example id suspect its similar, you can have a ring buffer which should never overrun  because you know the timing involved on the i2c and you know the timing of the event loop (k-rate).<br>so under normal circumstances you know the max number of i2c events you expect in a k-rate cycle - and a bit more space for headroom and your done.</p>

<p>in someways I guess its a bit like setting the sample rate buffer size on a computer - you set it as low as you can go without experiencing issues</p>

<p>anyway, its just an idea - my personal preference is to avoid locks in the audio thread at all costs, as they invariable lead to little glitches when load increases,  which are really hard to track down later.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='Best Practices for I2C Objects/Drivers'>
      <hr>
  </div>






        <!-- :preload-content -->
        <footer>
          <nav itemscope itemtype='http://schema.org/SiteNavigationElement'>
            <a href='/'>Home</a>
            <a href="/categories">Categories</a>
            <a href="/guidelines">FAQ/Guidelines</a>
            <a href="/tos">Terms of Service</a>
            <a href="/privacy">Privacy Policy</a>
          </nav>
        </footer>
      </div>

      <footer id='noscript-footer'>
        <p>Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
      </footer>
    </noscript>

      

    <section id='main'>
    </section>

    <div id='offscreen-content'>
    </div>

      <form id='hidden-login-form' method="post" action="/login" style="display: none;">
        <input name="username" type="text"     id="signin_username">
        <input name="password" type="password" id="signin_password">
        <input name="redirect" type="hidden">
        <input type="submit" id="signin-button" value="Log In">
      </form>

      <script>
      (function() {
        var ps = require('preload-store').default;
          ps.store("site", {"default_archetype":"regular","notification_types":{"mentioned":1,"replied":2,"quoted":3,"edited":4,"liked":5,"private_message":6,"invited_to_private_message":7,"invitee_accepted":8,"posted":9,"moved_post":10,"linked":11,"granted_badge":12,"invited_to_topic":13,"custom":14,"group_mentioned":15,"group_message_summary":16,"watching_first_post":17,"topic_reminder":18},"post_types":{"regular":1,"moderator_action":2,"small_action":3,"whisper":4},"groups":[{"id":1,"name":"admins"},{"id":0,"name":"everyone"},{"id":2,"name":"moderators"},{"id":3,"name":"staff"},{"id":10,"name":"trust_level_0"},{"id":11,"name":"trust_level_1"},{"id":12,"name":"trust_level_2"},{"id":13,"name":"trust_level_3"},{"id":14,"name":"trust_level_4"}],"filters":["latest","unread","new","read","posted","bookmarks"],"periods":["all","yearly","quarterly","monthly","weekly","daily"],"top_menu_items":["latest","unread","new","read","posted","bookmarks","category","categories","top"],"anonymous_top_menu_items":["latest","top","categories","category","categories","top"],"uncategorized_category_id":1,"is_readonly":false,"disabled_plugins":[],"user_field_max_length":2048,"suppressed_from_homepage_category_ids":[],"post_action_types":[{"name_key":"bookmark","name":"Bookmark","description":"Bookmark this post","short_description":"Bookmark this post","long_form":"bookmarked this post","is_flag":false,"icon":null,"id":1,"is_custom_flag":false},{"name_key":"like","name":"Like","description":"Like this post","short_description":"Like this post","long_form":"liked this","is_flag":false,"icon":"heart","id":2,"is_custom_flag":false},{"name_key":"off_topic","name":"Off-Topic","description":"This post is not relevant to the current discussion as defined by the title and first post, and should probably be moved elsewhere.","short_description":"Not relevant to the discussion","long_form":"flagged this as off-topic","is_flag":true,"icon":null,"id":3,"is_custom_flag":false},{"name_key":"inappropriate","name":"Inappropriate","description":"This post contains content that a reasonable person would consider offensive, abusive, or a violation of \u003ca href=\"/guidelines\"\u003eour community guidelines\u003c/a\u003e.","short_description":"A violation of \u003ca href=\"/guidelines\"\u003eour community guidelines\u003c/a\u003e","long_form":"flagged this as inappropriate","is_flag":true,"icon":null,"id":4,"is_custom_flag":false},{"name_key":"vote","name":"Vote","description":"Vote for this post","short_description":"Vote for this post","long_form":"voted for this post","is_flag":false,"icon":null,"id":5,"is_custom_flag":false},{"name_key":"spam","name":"Spam","description":"This post is an advertisement, or vandalism. It is not useful or relevant to the current topic.","short_description":"This is an advertisement or vandalism","long_form":"flagged this as spam","is_flag":true,"icon":null,"id":8,"is_custom_flag":false},{"name_key":"notify_user","name":"Send @{{username}} a message","description":"I want to talk to this person directly and privately about their post.","short_description":"I want to talk to this person directly and privately about their post.","long_form":"messaged user","is_flag":true,"icon":null,"id":6,"is_custom_flag":true},{"name_key":"notify_moderators","name":"Something Else","description":"This post requires staff attention for another reason not listed above.","short_description":"Requires staff attention for another reason","long_form":"flagged this for staff attention","is_flag":true,"icon":null,"id":7,"is_custom_flag":true}],"topic_flag_types":[{"name_key":"inappropriate","name":"Inappropriate","description":"This topic contains content that a reasonable person would consider offensive, abusive, or a violation of \u003ca href=\"/guidelines\"\u003eour community guidelines\u003c/a\u003e.","short_description":"translation missing: en.topic_flag_types.inappropriate.short_description","long_form":"flagged this as inappropriate","is_flag":true,"icon":null,"id":4,"is_custom_flag":false},{"name_key":"spam","name":"Spam","description":"This topic is an advertisement. It is not useful or relevant to this site, but promotional in nature.","short_description":"translation missing: en.topic_flag_types.spam.short_description","long_form":"flagged this as spam","is_flag":true,"icon":null,"id":8,"is_custom_flag":false},{"name_key":"notify_moderators","name":"Something Else","description":"This topic requires general staff attention based on the \u003ca href=\"/guidelines\"\u003eguidelines\u003c/a\u003e, \u003ca href=\"/tos\"\u003eTOS\u003c/a\u003e, or for another reason not listed above.","short_description":"translation missing: en.topic_flag_types.notify_moderators.short_description","long_form":"flagged this for moderator attention","is_flag":true,"icon":null,"id":7,"is_custom_flag":true}],"can_create_tag":null,"can_tag_topics":null,"tags_filter_regexp":"[/\\?#\\[\\]@!\\$\u0026'\\(\\)\\*\\+,;=\\.%\\\\`^\\s|\\{\\}\"\u003c\u003e]+","top_tags":["midi","controllers","modular","linux","1.0.11","macos","windows","troubleshooting","usb","challenge","wavetable","library","14bit","math","faust","dsp","out","tips","current"],"topic_featured_link_allowed_category_ids":[4,15,12,1,6,2,5,10,14,9,3,8,16,11,7,13],"user_themes":[{"theme_key":"b5ce34aa-3ee1-4d3e-b190-0a2ab62c7408","name":"Migrated from Site Text","default":true}],"categories":[{"id":1,"name":"Uncategorized","color":"AB9364","text_color":"FFFFFF","slug":"uncategorized","topic_count":-1,"post_count":1,"position":0,"description":"Topics that don't need a category, or don't fit into any other existing category.","description_text":"","topic_url":"/t/","read_restricted":false,"permission":null,"notification_level":1,"topic_template":null,"has_children":false,"sort_order":null,"sort_ascending":null,"show_subcategory_list":false,"num_featured_topics":3,"default_view":null,"subcategory_list_style":"rows_with_featured_topics","default_top_period":"all","uploaded_logo":null,"uploaded_background":null},{"id":10,"name":"User Guide","color":"3AB54A","text_color":"FFFFFF","slug":"user-guide","topic_count":24,"post_count":102,"position":1,"description":"This category contains posts to help users use Axoloti, a dynamic user guide.","description_text":"This category contains posts to help users use Axoloti, a dynamic user guide.","topic_url":"/t/about-the-user-guide-category/51","read_restricted":false,"permission":null,"notification_level":1,"topic_template":"","has_children":false,"sort_order":null,"sort_ascending":null,"show_subcategory_list":false,"num_featured_topics":3,"default_view":null,"subcategory_list_style":"rows_with_featured_topics","default_top_period":"all","uploaded_logo":null,"uploaded_background":null},{"id":8,"name":"Helpdesk","color":"9EB83B","text_color":"FFFFFF","slug":"helpdesk","topic_count":371,"post_count":2995,"position":2,"description":"This category is for reporting issues and bugs\u003cbr\u003ePlease use other categories for discussions on features or questions or \"how to?\"","description_text":"This category is for reporting issues and bugsPlease use other categories for discussions on features or questions or \"how to?\"","topic_url":"/t/about-the-helpdesk-category/23","read_restricted":false,"permission":null,"notification_level":1,"topic_template":"","has_children":false,"sort_order":null,"sort_ascending":null,"show_subcategory_list":false,"num_featured_topics":3,"default_view":null,"subcategory_list_style":"rows_with_featured_topics","default_top_period":"all","uploaded_logo":null,"uploaded_background":null},{"id":13,"name":"Community Library","color":"9EB83B","text_color":"FFFFFF","slug":"community-library","topic_count":54,"post_count":2917,"position":3,"description":"Category for the community library","description_text":"Category for the community library","topic_url":"/t/about-the-community-library-category/1005","read_restricted":false,"permission":null,"notification_level":1,"topic_template":"","has_children":false,"sort_order":null,"sort_ascending":null,"show_subcategory_list":false,"num_featured_topics":3,"default_view":null,"subcategory_list_style":"rows_with_featured_topics","default_top_period":"all","uploaded_logo":null,"uploaded_background":null},{"id":7,"name":"Patching","color":"AB9364","text_color":"FFFFFF","slug":"patching","topic_count":984,"post_count":8056,"position":4,"description":"This category is for discussion about patching Axoloti, and sharing patches.","description_text":"This category is for discussion about patching Axoloti, and sharing patches.","topic_url":"/t/about-the-patching-category/14","read_restricted":false,"permission":null,"notification_level":1,"topic_template":"","has_children":false,"sort_order":null,"sort_ascending":null,"show_subcategory_list":false,"num_featured_topics":3,"default_view":null,"subcategory_list_style":"rows_with_featured_topics","default_top_period":"all","uploaded_logo":null,"uploaded_background":null},{"id":5,"name":"Hardware","color":"AB9364","text_color":"FFFFFF","slug":"hardware","topic_count":643,"post_count":7099,"position":5,"description":"This category is intended for discussion about the Axoloti hardware and connecting to other hardware, including , connecting midi controllers and other hardware, related hardware projects. ","description_text":"This category is intended for discussion about the Axoloti hardware and connecting to other hardware, including , connecting midi controllers and other hardware, related hardware projects.","topic_url":"/t/about-the-hardware-category/12","read_restricted":false,"permission":null,"notification_level":1,"topic_template":null,"has_children":false,"sort_order":null,"sort_ascending":null,"show_subcategory_list":false,"num_featured_topics":3,"default_view":null,"subcategory_list_style":"rows_with_featured_topics","default_top_period":"all","uploaded_logo":null,"uploaded_background":null},{"id":6,"name":"Software","color":"AB9364","text_color":"FFFFFF","slug":"software","topic_count":325,"post_count":3299,"position":6,"description":"This category is for posts regarding the software of Axoloti, this includes the Axoloti patching GUI, Axoloti Objects (axo) and firmware. Please use the Patching category to discuss patching Axoloti. ","description_text":"This category is for posts regarding the software of Axoloti, this includes the Axoloti patching GUI, Axoloti Objects (axo) and firmware. Please use the Patching category to discuss patching Axoloti.","topic_url":"/t/about-the-software-category/13","read_restricted":false,"permission":null,"notification_level":1,"topic_template":null,"has_children":false,"sort_order":null,"sort_ascending":null,"show_subcategory_list":false,"num_featured_topics":3,"default_view":null,"subcategory_list_style":"rows_with_featured_topics","default_top_period":"all","uploaded_logo":null,"uploaded_background":null},{"id":16,"name":"AxoObject coding","color":"AB9364","text_color":"FFFFFF","slug":"axoobject-code","topic_count":264,"post_count":2155,"position":7,"description":"Category to discuss coding Axoloti Objects.","description_text":"Category to discuss coding Axoloti Objects.","topic_url":"/t/about-the-axoobject-coding-category/1519","read_restricted":false,"permission":null,"notification_level":1,"topic_template":null,"has_children":false,"sort_order":null,"sort_ascending":null,"show_subcategory_list":false,"num_featured_topics":3,"default_view":null,"subcategory_list_style":"rows_with_featured_topics","default_top_period":"all","uploaded_logo":null,"uploaded_background":null},{"id":14,"name":"News/Events","color":"283890","text_color":"FFFFFF","slug":"events","topic_count":30,"post_count":106,"position":8,"description":"Meetups, workshops, presentations, all sort of events.\u003cbr\u003eIt's perfectly fine for users to announce and discuss their own events, as long as it is related to Axoloti somehow.\u003cbr\u003eStart your topic title with the name of the area where your event will happen.","description_text":"Meetups, workshops, presentations, all sort of events.It's perfectly fine for users to announce and discuss their own events, as long as it is related to Axoloti somehow.Start your topic title with the name of the area where your event will happen.","topic_url":"/t/about-the-events-category/1142","read_restricted":false,"permission":null,"notification_level":1,"topic_template":"","has_children":false,"sort_order":null,"sort_ascending":null,"show_subcategory_list":false,"num_featured_topics":3,"default_view":null,"subcategory_list_style":"rows_with_featured_topics","default_top_period":"all","uploaded_logo":null,"uploaded_background":null},{"id":12,"name":"Challenges","color":"0E76BD","text_color":"FFFFFF","slug":"challenges","topic_count":19,"post_count":266,"position":9,"description":"This category is for challenges, competitions and discussions related to these.\u003cbr\u003eposters are reminded when entering challenges and competitions to not include any copyrighted material","description_text":"This category is for challenges, competitions and discussions related to these.posters are reminded when entering challenges and competitions to not include any copyrighted material","topic_url":"/t/about-the-challenges-category/838","read_restricted":false,"permission":null,"notification_level":1,"topic_template":"","has_children":false,"sort_order":null,"sort_ascending":null,"show_subcategory_list":false,"num_featured_topics":3,"default_view":null,"subcategory_list_style":"rows_with_featured_topics","default_top_period":"all","uploaded_logo":null,"uploaded_background":null},{"id":9,"name":"Your Music/Projects","color":"0E76BD","text_color":"FFFFFF","slug":"your-music-projects","topic_count":180,"post_count":1259,"position":10,"description":"Have some music that you have made with Axoloti? or an interesting project you would like to share the communities?\u003cbr\u003eTells us about it here.","description_text":"Have some music that you have made with Axoloti? or an interesting project you would like to share the communities?Tells us about it here.","topic_url":"/t/about-the-your-music-projects-category/25","read_restricted":false,"permission":null,"notification_level":1,"topic_template":"","has_children":false,"sort_order":null,"sort_ascending":null,"show_subcategory_list":false,"num_featured_topics":3,"default_view":null,"subcategory_list_style":"rows_with_featured_topics","default_top_period":"all","uploaded_logo":null,"uploaded_background":null},{"id":15,"name":"Lounge","color":"AB9364","text_color":"FFFFFF","slug":"lounge","topic_count":100,"post_count":1681,"position":11,"description":"This category is for discussions that are related to Axoloti generally but are not specifically about Axoloti.\u003cbr\u003e(please ensure it has some relevance to Axoloti, rather than general discussion) ","description_text":"This category is for discussions that are related to Axoloti generally but are not specifically about Axoloti.(please ensure it has some relevance to Axoloti, rather than general discussion)","topic_url":"/t/about-the-lounge-category/1277","read_restricted":false,"permission":null,"notification_level":1,"topic_template":null,"has_children":false,"sort_order":null,"sort_ascending":null,"show_subcategory_list":false,"num_featured_topics":3,"default_view":null,"subcategory_list_style":"rows_with_featured_topics","default_top_period":"all","uploaded_logo":null,"uploaded_background":null},{"id":11,"name":"Developer","color":"BF1E2E","text_color":"FFFFFF","slug":"developer","topic_count":65,"post_count":641,"position":12,"description":"This category is for discussion about the development of Axoloti at a low level, its intended only for developers/programmers.","description_text":"This category is for discussion about the development of Axoloti at a low level, its intended only for developers/programmers.","topic_url":"/t/about-the-developer-category/735","read_restricted":false,"permission":null,"notification_level":1,"topic_template":"This category is for low level discussion on the development of Axoloti, its is intended for developers/programmers only.","has_children":false,"sort_order":null,"sort_ascending":null,"show_subcategory_list":false,"num_featured_topics":3,"default_view":null,"subcategory_list_style":"rows_with_featured_topics","default_top_period":"all","uploaded_logo":null,"uploaded_background":null},{"id":3,"name":"Website and Forum","color":"808281","text_color":"FFFFFF","slug":"meta","topic_count":45,"post_count":410,"position":13,"description":"Discussion about this site, its organization, how it works, and how we can improve it.","description_text":"Discussion about this site, its organization, how it works, and how we can improve it.","topic_url":"/t/about-the-meta-category/2","read_restricted":false,"permission":null,"notification_level":1,"topic_template":"","has_children":false,"sort_order":null,"sort_ascending":null,"show_subcategory_list":false,"num_featured_topics":3,"default_view":null,"subcategory_list_style":"rows_with_featured_topics","default_top_period":"all","uploaded_logo":null,"uploaded_background":null}],"trust_levels":[{"id":0,"name":"new user"},{"id":1,"name":"basic user"},{"id":2,"name":"member"},{"id":3,"name":"regular"},{"id":4,"name":"leader"}],"archetypes":[{"id":"regular","name":"Regular Topic","options":[]},{"id":"banner","name":"Banner Topic","options":[]}],"user_fields":[]});
          ps.store("siteSettings", {"title":"Axoloti Community","contact_email":"johannes.taelman@gmail.com","contact_url":"","logo_url":"/uploads/default/original/1X/b22e6e9ef608f1e17a1de19b733d043beff77f05.png","logo_small_url":"/uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png","mobile_logo_url":"","favicon_url":"/uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png","allow_user_locale":false,"suggested_topics":5,"track_external_right_clicks":false,"ga_universal_tracking_code":"UA-56017691-4","ga_universal_domain_name":"auto","ga_tracking_code":"","ga_domain_name":"","gtm_container_id":"","top_menu":"categories|latest|new|unread|top","post_menu":"like-count|like|share|flag|edit|bookmark|delete|admin|reply","post_menu_hidden_items":"flag|bookmark|edit|delete|admin","share_links":"twitter|facebook|email","desktop_category_page_style":"categories_and_latest_topics","category_colors":"BF1E2E|F1592A|F7941D|9EB83B|3AB54A|12A89D|25AAE2|0E76BD|652D90|92278F|ED207B|8C6238|231F20|808281|B3B5B4|283890","category_style":"bullet","enable_mobile_theme":true,"relative_date_duration":30,"fixed_category_positions":true,"fixed_category_positions_on_create":false,"enable_badges":true,"enable_badge_sql":false,"enable_whispers":false,"invite_only":false,"login_required":false,"must_approve_users":false,"enable_local_logins":true,"allow_new_registrations":true,"enable_signup_cta":true,"enable_google_oauth2_logins":false,"enable_yahoo_logins":false,"enable_twitter_logins":false,"enable_instagram_logins":false,"enable_facebook_logins":false,"enable_github_logins":false,"enable_sso":false,"sso_overrides_avatar":false,"min_username_length":3,"max_username_length":20,"min_password_length":10,"min_admin_password_length":15,"logout_redirect":"","full_name_required":false,"enable_names":true,"invites_per_page":40,"delete_user_max_post_age":60,"delete_all_posts_max":15,"show_email_on_profile":false,"prioritize_username_in_ux":true,"enable_user_directory":true,"allow_anonymous_posting":false,"anonymous_posting_min_trust_level":1,"hide_user_profiles_from_public":false,"enable_group_directory":true,"min_post_length":20,"min_first_post_length":20,"min_private_message_post_length":10,"max_post_length":32000,"topic_featured_link_enabled":true,"min_topic_title_length":15,"max_topic_title_length":255,"min_private_message_title_length":2,"allow_uncategorized_topics":false,"min_title_similar_length":10,"min_body_similar_length":15,"enable_private_messages":true,"edit_history_visible_to_public":false,"delete_removed_posts_after":24,"enable_experimental_markdown_it":false,"traditional_markdown_linebreaks":false,"enable_markdown_typographer":false,"allow_html_tables":false,"suppress_reply_directly_below":true,"suppress_reply_directly_above":true,"max_reply_history":1,"newuser_max_images":1,"newuser_max_attachments":2,"show_pinned_excerpt_mobile":true,"show_pinned_excerpt_desktop":true,"display_name_on_posts":false,"show_time_gap_days":7,"short_progress_text_threshold":10000,"default_code_lang":"auto","autohighlight_all_code":false,"highlighted_languages":"apache|bash|cs|cpp|css|coffeescript|diff|xml|http|ini|json|java|javascript|makefile|markdown|nginx|objectivec|ruby|perl|php|python|sql|handlebars","censored_words":"","censored_pattern":"","enable_emoji":true,"emoji_set":"twitter","code_formatting_style":"4-spaces-indent","allowed_href_schemes":"","email_time_window_mins":10,"disable_digest_emails":false,"email_in":false,"disable_emails":false,"bounce_score_threshold":4,"max_image_size_kb":3072,"max_attachment_size_kb":3072,"authorized_extensions":"jpg|jpeg|png|gif|axo|axp|axs|axh|fpd|brd|axt","max_image_width":690,"max_image_height":500,"prevent_anons_from_downloading_files":false,"enable_s3_uploads":false,"allow_profile_backgrounds":true,"allow_uploaded_avatars":true,"allow_animated_avatars":false,"default_avatars":"","external_system_avatars_enabled":true,"external_system_avatars_url":"/letter_avatar_proxy/v2/letter/{first_letter}/{color}/{size}.png","allow_staff_to_upload_any_file_in_pm":true,"tl1_requires_read_posts":30,"tl3_links_no_follow":false,"use_admin_ip_whitelist":false,"max_oneboxes_per_post":50,"alert_admins_if_errors_per_minute":0,"alert_admins_if_errors_per_hour":0,"max_prints_per_hour_per_user":5,"enable_long_polling":true,"long_polling_base_url":"/","background_polling_interval":60000,"polling_interval":3000,"anon_polling_interval":15000,"flush_timings_secs":20,"verbose_localization":false,"max_new_topics":500,"tos_url":"","privacy_policy_url":"","faq_url":"","maximum_backups":5,"min_search_term_length":3,"version_checks":true,"suppress_uncategorized_badge":true,"topic_views_heat_low":1000,"topic_views_heat_medium":2000,"topic_views_heat_high":5000,"topic_post_like_heat_low":0.5,"topic_post_like_heat_medium":1.0,"topic_post_like_heat_high":2.0,"history_hours_low":12,"history_hours_medium":24,"history_hours_high":48,"cold_age_days_low":14,"cold_age_days_medium":90,"cold_age_days_high":180,"global_notice":"","show_create_topics_notice":true,"bootstrap_mode_min_users":50,"bootstrap_mode_enabled":false,"automatically_unpin_topics":true,"read_time_word_count":500,"disable_mailing_list_mode":false,"default_topics_automatic_unpin":true,"tagging_enabled":true,"tag_style":"simple","max_tags_per_topic":5,"max_tag_length":20,"min_trust_level_to_tag_topics":0,"max_tag_search_results":5,"show_filter_by_tag":true,"tags_sort_alphabetically":false,"staff_tags":"","suppress_overlapping_tags_in_list":false,"discourse_narrative_bot_enabled":true,"poll_enabled":true,"poll_maximum_options":20,"details_enabled":true,"available_locales":"ar|bs_BA|cs|da|de|el|en|es|et|fa_IR|fi|fr|gl|he|id|it|ja|ko|nb_NO|nl|pl_PL|pt|pt_BR|ro|ru|sk|sq|sv|te|tr_TR|uk|ur|vi|zh_CN|zh_TW"});
          ps.store("customHTML", {"top":"","footer":""});
          ps.store("banner", {});
          ps.store("customEmoji", []);
          ps.store("translationOverrides", {});
          ps.store("topic_5075", {"post_stream":{"posts":[{"id":31081,"name":"Jason T Harris","username":"deadsy","avatar_template":"/user_avatar/community.axoloti.com/deadsy/{size}/5105_1.png","created_at":"2018-10-20T17:18:08.735Z","cooked":"\u003cp\u003e\u003ca class=\"mention\" href=\"/u/smashedtransistors\"\u003e@SmashedTransistors\u003c/a\u003e wrote:\u003c/p\u003e\n\n\u003cblockquote\u003e\u003cp\u003eMaybe it is a good idea to start a new thread about \"tips and good practices for I2C objects\".\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003cp\u003eHere's my take on writing I2C drivers for Axoloti. Feel free to comment/contribute.\u003c/p\u003e\n\n\u003ch2\u003eIntroduction\u003c/h2\u003e\n\n\u003cp\u003eI2C is a shared bus technology.\u003cbr\u003e\u003ca href=\"https://en.wikipedia.org/wiki/I%C2%B2C\" rel=\"nofollow noopener\"\u003ei2c wikipedia\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eLot's of interesting chips have an I2C interface and the Axoloti provides an I2C bus on the IO pins.\u003cbr\u003eIf you have a new I2C device you want to hook up, you'll need to write an I2C driver/object for it.\u003c/p\u003e\n\n\u003cp\u003eI2C is a \u003cem\u003eshared\u003c/em\u003e bus.\u003c/p\u003e\n\n\u003cp\u003eThe Axoloti is the bus master. Each device is a bus slave. There can be multiple slaves on a single bus (each with a unique 7-bit I2C address). The Axoloti initiates a bus transaction (read/write) and the slave device responds. Each device is controlled by it's own driver- which will typically be a patch object.\u003c/p\u003e\n\n\u003cp\u003eHere are some best practices to ensure different device drivers work well on the same bus.\u003c/p\u003e\n\n\u003ch2\u003e1. Provide a way for the user to specify a unique device address.\u003c/h2\u003e\n\n\u003cp\u003eWhen the master (Axoloti) starts a transaction on the bus, it specifies the device it wants to talk to by using a 7-bit I2C address. The master talks to one device at a time, so each device needs a unique I2C address. The device datasheet will tell you which addresses a specific device can use. The device will often have some pins to customize (with hardware jumpers) some bits of the address. This allows the user to have multiple instances of the same device on the bus, each with a unique address. The driver writer needs to provide a way to specify which device address a driver should be using.\u003c/p\u003e\n\n\u003cp\u003eThe device address needs to be specified at compile time. On Axoloti this can be handled by an attribute in the object:\u003cbr\u003e\u003ccode\u003e\u003cbr\u003e\u0026lt;attribs\u0026gt;\u003cbr\u003e    \u0026lt;combo name=\"adr\"\u0026gt;\u003cbr\u003e      \u0026lt;MenuEntries\u0026gt;\u003cbr\u003e          \u0026lt;string\u0026gt;0x1d\u0026lt;/string\u0026gt;\u003cbr\u003e          \u0026lt;string\u0026gt;0x53\u0026lt;/string\u0026gt;\u003cbr\u003e      \u0026lt;/MenuEntries\u0026gt;\u003cbr\u003e      \u0026lt;CEntries\u0026gt;\u003cbr\u003e          \u0026lt;string\u0026gt;0x1d\u0026lt;/string\u0026gt;\u003cbr\u003e          \u0026lt;string\u0026gt;0x53\u0026lt;/string\u0026gt;\u003cbr\u003e      \u0026lt;/CEntries\u0026gt;\u003cbr\u003e    \u0026lt;/combo\u0026gt;\u003cbr\u003e\u0026lt;/attribs\u0026gt;\u003cbr\u003e\u003c/code\u003e\u003c/p\u003e\n\n\u003ch2\u003e2. Initialise the I2C bus only once.\u003c/h2\u003e\n\n\u003cp\u003eThe I2C bus needs to be initialized in the patch. A given patch might control multiple I2C devices, but the I2C bus should only be initialized once. The bus is initialized by a call to the i2cStart() function. This should \u003cem\u003enot\u003c/em\u003e be called within the driver because with multiple devices each driver would make a call to initialize the bus. It should be called through a single instance of the i2c config object.\u003cbr\u003e\u003ccode\u003e\u003cbr\u003eaxoloti-factory/objects/gpio/i2c/config.axo\u003cbr\u003e\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eThis object does not connect to anything in the patch, it just handles the IO setup and shutdown for the I2C bus.\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"//community.axoloti.com/uploads/default/original/2X/b/b06df6b64f4e7280e5bcba6611bca0567cfbb537.png\" width=\"299\" height=\"62\"\u003e\u003c/p\u003e\n\n\u003ch2\u003e3. Allocate I2C Transaction Buffers out of the SRAM2 segment.\u003c/h2\u003e\n\n\u003cp\u003eThe buffers used to tx/rx bytes from the I2C device need to be in the SRAM2 segment. If we look at the linker script we see:\u003cbr\u003e\u003ccode\u003e\u003cbr\u003eSRAM2  : org = 0x2001E000, len = 0x00002000 /* second half (8kB) of SRAM2 for DMA*/\u003cbr\u003e\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eThe bytes from memory to the I2C controller are DMA'ed so we need to use memory that can be DMA'ed. In the driver you can specify the segment in which the linker will allocate the storage by using the \"attribute\" pragma.\u003c/p\u003e\n\n\u003cp\u003eExample:\u003cbr\u003e\u003ccode\u003e\u003cbr\u003estatic uint8_t rxbuf[32] __attribute__ ((section(\".sram2\")));\u003cbr\u003e\u003c/code\u003e\u003cbr\u003eThis is more of a requirement than a best practice. If you don't do it the I2C bus transactions won't work.\u003c/p\u003e\n\n\u003ch2\u003e4. Device IO operations should be in their own thread.\u003c/h2\u003e\n\n\u003cp\u003eAxoloti uses ChibiOS which is a multi-threaded RTOS. The DSP thread calls the krate/srate functions of the patch and computes the audio. The DSP thread needs to run as quickly as possible so it can feed the codec.\u003cbr\u003eThe DSP thread should not be waiting for external IO to take place. The I2C bus operations should run in their own thread where they can run asynchronously without slowing down the DSP thread.\u003c/p\u003e\n\n\u003cp\u003eExample:\u003c/p\u003e\n\n\u003cp\u003eIn the init function we create the IO thread:\u003cbr\u003e\u003ccode\u003e\u003cbr\u003e// create the polling thread\u003cbr\u003es-\u0026gt;thd = chThdCreateStatic(s-\u0026gt;thd_wa, sizeof(s-\u0026gt;thd_wa), NORMALPRIO, adxl345_thread, (void *)s);\u003cbr\u003e\u003c/code\u003e\u003cbr\u003eAnd in the dispose function we terminate the thread:\u003cbr\u003e\u003ccode\u003e\u003cbr\u003e// stop thread\u003cbr\u003echThdTerminate(s-\u0026gt;thd);\u003cbr\u003echThdWait(s-\u0026gt;thd);\u003cbr\u003e\u003c/code\u003e\u003c/p\u003e\n\n\u003ch2\u003e5. Lock/Unlock the I2C bus around bus operations.\u003c/h2\u003e\n\n\u003cp\u003eWith each device driver running in its own thread we have multiple threads each trying to access the same I2C bus. The drivers will access the bus asynchronously, so we have to make sure access is properly shared. ChibiOS provides functions to lock/unlock the bus: i2cAcquireBus(), i2cReleaseBus() A given thread needs to get the lock before it uses the bus and release the lock after it has finished with the bus.\u003c/p\u003e\n\n\u003cp\u003eExample:\u003cbr\u003e\u003ccode\u003e\u003cbr\u003ei2cAcquireBus(s-\u0026gt;dev);\u003cbr\u003emsg_t rc = i2cMasterReceiveTimeout(s-\u0026gt;dev, s-\u0026gt;adr, s-\u0026gt;rx, 2, TTP229_I2C_TIMEOUT);\u003cbr\u003ei2cReleaseBus(s-\u0026gt;dev);\u003cbr\u003e\u003c/code\u003e\u003cbr\u003eIt's up to the driver writer to minimize lock time and not hog the bus. Many devices will be periodically polled/updated. Be a good neighbor. Take a look at the device datasheet and work out how slowly you can poll the device.\u003c/p\u003e\n\n\u003ch2\u003e6. Lock shared memory access between DSP and IO threads.\u003c/h2\u003e\n\n\u003cp\u003eThe device driver IO thread and DSP thread need to communicate. This is typically done with memory shared between the threads. When one thread is writing the data, the other thread should not be reading it, and vice versa. Each thread has to get exclusive access to the shared memory before it reads or write it.\u003c/p\u003e\n\n\u003cp\u003eExample:\u003c/p\u003e\n\n\u003cp\u003eIn the IO Thread:\u003cbr\u003e\u003ccode\u003e\u003cbr\u003e// write to shared variables\u003cbr\u003echSysLock();\u003cbr\u003es-\u0026gt;x = x;\u003cbr\u003es-\u0026gt;y = y;\u003cbr\u003es-\u0026gt;z = z;\u003cbr\u003echSysUnlock();\u003cbr\u003e\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eIn the DSP Thread:\u003cbr\u003e\u003ccode\u003e\u003cbr\u003e// read from shared variables\u003cbr\u003echSysLock();\u003cbr\u003ex = s-\u0026gt;x;\u003cbr\u003ey = s-\u0026gt;y;\u003cbr\u003ez = s-\u0026gt;z;\u003cbr\u003echSysUnlock();\u003cbr\u003e\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eIn this example if you don't lock the shared variable access, you will potentially have x,y,z values being mixed up between samples.\u003c/p\u003e\n\n\u003cp\u003eNote: Using chSysLock/chSysUnlock is an interrupt disable/enable. This gets the job done, but should only be used for very short lock periods because it stops all threads, not just the one that is contending for the variable access. ChibiOS provides other, more sophisticated, methods for inter thread communication (not all of which are enabled in the standard Axoloti firmware...).\u003c/p\u003e\n\n\u003ch2\u003eDriver Examples\u003c/h2\u003e\n\n\u003cp\u003eHere are some I2C object/drivers that use the aforementioned practices:\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/axoloti/axoloti-contrib/tree/1.0.12/objects/deadsy/mpr121\" rel=\"nofollow noopener\"\u003empr121 driver\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/axoloti/axoloti-contrib/tree/1.0.12/objects/deadsy/ttp229\" rel=\"nofollow noopener\"\u003ettp229 driver\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eNote:\u003cbr\u003eI have an aversion to writing C code in XML files, so the bulk of the driver code for these examples is in the *.h include file. This makes the driver code a bit different from the \"all in the axo\" form but for either form the best practices still apply.\u003c/p\u003e","post_number":1,"post_type":1,"updated_at":"2018-10-20T17:22:44.290Z","reply_count":1,"reply_to_post_number":null,"quote_count":0,"avg_time":109,"incoming_link_count":249,"reads":75,"score":1405.45,"yours":false,"topic_id":5075,"topic_slug":"best-practices-for-i2c-objects-drivers","display_username":"Jason T Harris","primary_group_name":null,"primary_group_flair_url":null,"primary_group_flair_bg_color":null,"primary_group_flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"link_counts":[{"url":"https://github.com/axoloti/axoloti-contrib/tree/1.0.12/objects/deadsy/mpr121","internal":false,"reflection":false,"title":"axoloti-contrib/objects/deadsy/mpr121 at 1.0.12 · axoloti/axoloti-contrib · GitHub","clicks":44},{"url":"https://github.com/axoloti/axoloti-contrib/tree/1.0.12/objects/deadsy/ttp229","internal":false,"reflection":false,"title":"axoloti-contrib/objects/deadsy/ttp229 at 1.0.12 · axoloti/axoloti-contrib · GitHub","clicks":25},{"url":"https://en.wikipedia.org/wiki/I%C2%B2C","internal":false,"reflection":false,"title":"I²C - Wikipedia","clicks":8},{"url":"http://community.axoloti.com/t/spi-i2c-oled-display/638/150","internal":true,"reflection":true,"title":"SPI/I2C OLED display","clicks":0}],"read":true,"user_title":null,"actions_summary":[{"id":2,"count":7}],"moderator":false,"admin":false,"staff":false,"user_id":1672,"hidden":false,"hidden_reason_id":null,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":false,"wiki":false},{"id":31083,"name":"Mark Harris","username":"thetechnobear","avatar_template":"/user_avatar/community.axoloti.com/thetechnobear/{size}/6_1.png","created_at":"2018-10-20T19:00:11.727Z","cooked":"\u003cp\u003ecool stuff, and a great write up!\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003cp\u003ewon't the chSysLock() potentially block the DSP (for a very short while) ?!\u003c/p\u003e\n\n\u003cp\u003ewhat id be tempted to do is use a lock free ring buffer, this is what I did for the (firmware) midi implementation. doesn't have to be a complex implementation if you have a good understanding of the timing of the IO on the I2C - the buffer only has to be big enough to allow for 'some latency/jitter'\u003c/p\u003e\n\n\u003caside class=\"quote\" data-post=\"1\" data-topic=\"5075\"\u003e\u003cdiv class=\"title\"\u003e\n\u003cdiv class=\"quote-controls\"\u003e\u003c/div\u003e\n\u003cimg alt=\"\" width=\"20\" height=\"20\" src=\"//community.axoloti.com/user_avatar/community.axoloti.com/deadsy/40/5105_1.png\" class=\"avatar\"\u003edeadsy:\u003c/div\u003e\n\u003cblockquote\u003e\u003cp\u003eI have an aversion to writing C code in XML files, so the bulk of the driver code for these examples is in the *.h include file. \u003c/p\u003e\u003c/blockquote\u003e\u003c/aside\u003e\n\n\u003cp\u003eyeah, I do the same for anything that's non-trivial\u003c/p\u003e","post_number":2,"post_type":1,"updated_at":"2018-10-20T19:02:08.672Z","reply_count":0,"reply_to_post_number":null,"quote_count":1,"avg_time":29,"incoming_link_count":0,"reads":55,"score":12.45,"yours":false,"topic_id":5075,"topic_slug":"best-practices-for-i2c-objects-drivers","display_username":"Mark Harris","primary_group_name":null,"primary_group_flair_url":null,"primary_group_flair_bg_color":null,"primary_group_flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"actions_summary":[],"moderator":true,"admin":true,"staff":true,"user_id":5,"hidden":false,"hidden_reason_id":null,"trust_level":4,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":false,"wiki":false},{"id":31091,"name":"Jason T Harris","username":"deadsy","avatar_template":"/user_avatar/community.axoloti.com/deadsy/{size}/5105_1.png","created_at":"2018-10-21T15:55:01.858Z","cooked":"\u003cp\u003e\u003ca class=\"mention\" href=\"/u/thetechnobear\"\u003e@thetechnobear\u003c/a\u003e says:\u003c/p\u003e\n\n\u003cblockquote\u003e\u003cp\u003ewon't the chSysLock() potentially block the DSP\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003cp\u003eYes - it's turns into a global interrupt disable, so the thread can't be preempted until it has called the unlock.\u003c/p\u003e\n\n\u003cp\u003eFor something like a touch sensor driver you only need a single uint32 as the result of the sensor read so I think a quick lock/unlock around the shared memory reference is probably about as fast as you can manage.\u003c/p\u003e\n\n\u003cp\u003eSomeone might say: \"You should be using a mutex!\"\u003c/p\u003e\n\n\u003cp\u003eCheck it out:\u003c/p\u003e\n\n\u003cpre\u003e\u003ccode\u003evoid chMtxLock(Mutex *mp) {\n  chSysLock();\n  chMtxLockS(mp);\n  chSysUnlock();\n}\u003c/code\u003e\u003c/pre\u003e\n\n\u003cp\u003eStill doing a quick global interrupt disable/enable. If you only have to share a single uint32 then the interrupt disable/enable will be faster. It's also worth noting that the DSP thread can't spend its time waiting on any sort of lock. Whatever you do it needs to be quick.\u003c/p\u003e\n\n\u003cp\u003eOf course for some drivers (E.g. a keyboard scanner) you may need something more sophisticated like a circular buffer, in which case a the code needs to be more complicated. If you've got the chops to write lock-less code that works properly, more power to you \u003cimg src=\"//community.axoloti.com/images/emoji/twitter/slight_smile.png?v=5\" title=\":slight_smile:\" class=\"emoji\" alt=\":slight_smile:\"\u003e \u003c/p\u003e\n\n\u003cp\u003eBTW - ChibiOS has a nice feature called mailboxes.\u003cbr\u003e\u003ca href=\"http://www.chibios.org/dokuwiki/doku.php?id=chibios:book:kernel_mailboxes\" rel=\"nofollow noopener\"\u003eRT mailboxes\u003c/a\u003e\u003cbr\u003eIt would be nice to use in drivers, but the feature is not enabled in the standard firmware build. Could we get it enabled for the next release?\u003c/p\u003e","post_number":3,"post_type":1,"updated_at":"2018-10-21T15:55:01.858Z","reply_count":1,"reply_to_post_number":null,"quote_count":0,"avg_time":32,"incoming_link_count":1,"reads":49,"score":21.4,"yours":false,"topic_id":5075,"topic_slug":"best-practices-for-i2c-objects-drivers","display_username":"Jason T Harris","primary_group_name":null,"primary_group_flair_url":null,"primary_group_flair_bg_color":null,"primary_group_flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"link_counts":[{"url":"http://www.chibios.org/dokuwiki/doku.php?id=chibios:book:kernel_mailboxes","internal":false,"reflection":false,"title":"ChibiOS free embedded RTOS - RT Mailboxes","clicks":4}],"read":true,"user_title":null,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":1672,"hidden":false,"hidden_reason_id":null,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":false,"wiki":false},{"id":31092,"name":"Mark Harris","username":"thetechnobear","avatar_template":"/user_avatar/community.axoloti.com/thetechnobear/{size}/6_1.png","created_at":"2018-10-21T18:59:21.708Z","cooked":"\u003cp\u003eI didn’t say use a mutex, i said use a lock free strategy.\u003c/p\u003e","post_number":4,"post_type":1,"updated_at":"2018-10-21T18:59:21.708Z","reply_count":0,"reply_to_post_number":3,"quote_count":0,"avg_time":16,"incoming_link_count":0,"reads":48,"score":10.4,"yours":false,"topic_id":5075,"topic_slug":"best-practices-for-i2c-objects-drivers","display_username":"Mark Harris","primary_group_name":null,"primary_group_flair_url":null,"primary_group_flair_bg_color":null,"primary_group_flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"reply_to_user":{"username":"deadsy","avatar_template":"/user_avatar/community.axoloti.com/deadsy/{size}/5105_1.png"},"actions_summary":[],"moderator":true,"admin":true,"staff":true,"user_id":5,"hidden":false,"hidden_reason_id":null,"trust_level":4,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":false,"wiki":false},{"id":31094,"name":"","username":"SmashedTransistors","avatar_template":"/user_avatar/community.axoloti.com/smashedtransistors/{size}/3147_1.png","created_at":"2018-10-21T20:44:58.860Z","cooked":"\u003cp\u003eWould this kind of strategy lead to use of double or triple buffering ?\u003c/p\u003e","post_number":5,"post_type":1,"updated_at":"2018-10-21T20:44:58.860Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"avg_time":14,"incoming_link_count":0,"reads":48,"score":10.3,"yours":false,"topic_id":5075,"topic_slug":"best-practices-for-i2c-objects-drivers","display_username":"","primary_group_name":null,"primary_group_flair_url":null,"primary_group_flair_bg_color":null,"primary_group_flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":967,"hidden":false,"hidden_reason_id":null,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":false,"wiki":false},{"id":31133,"name":"Jason T Harris","username":"deadsy","avatar_template":"/user_avatar/community.axoloti.com/deadsy/{size}/5105_1.png","created_at":"2018-10-23T17:07:55.933Z","cooked":"\u003cp\u003e\u003ca class=\"mention\" href=\"/u/thetechnobear\"\u003e@thetechnobear\u003c/a\u003e \u003c/p\u003e\n\n\u003cblockquote\u003e\u003cp\u003euse a lock free ring buffer, this is what I did for the (firmware) midi implementation. \u003c/p\u003e\u003c/blockquote\u003e\n\n\u003cp\u003eCan you point me to a code reference?\u003cbr\u003eI've been looking for telltale strex/ldrex instructions, but I don't see anything in either master or experimental...\u003c/p\u003e\n\n\u003cp\u003eThanks.\u003c/p\u003e","post_number":6,"post_type":1,"updated_at":"2018-10-23T17:07:55.933Z","reply_count":1,"reply_to_post_number":null,"quote_count":0,"avg_time":15,"incoming_link_count":0,"reads":47,"score":15.15,"yours":false,"topic_id":5075,"topic_slug":"best-practices-for-i2c-objects-drivers","display_username":"Jason T Harris","primary_group_name":null,"primary_group_flair_url":null,"primary_group_flair_bg_color":null,"primary_group_flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":1672,"hidden":false,"hidden_reason_id":null,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":false,"wiki":false},{"id":31154,"name":"","username":"SmashedTransistors","avatar_template":"/user_avatar/community.axoloti.com/smashedtransistors/{size}/3147_1.png","created_at":"2018-10-25T00:16:30.311Z","cooked":"\u003cp\u003eIs this related to \u003ca href=\"https://en.wikipedia.org/wiki/Load-link/store-conditional\" rel=\"nofollow noopener\"\u003elock-free atomic read-modify-write operation\u003c/a\u003e ? Is it useful in a single core processor ?\u003cbr\u003eAs I did not had to care about multi-threading on the Axoloti yet, I'm not aware of all the mechanisms available. \u003cbr\u003eThat's very interesting.\u003c/p\u003e","post_number":7,"post_type":1,"updated_at":"2018-10-25T00:23:37.278Z","reply_count":0,"reply_to_post_number":6,"quote_count":0,"avg_time":11,"incoming_link_count":0,"reads":42,"score":8.95,"yours":false,"topic_id":5075,"topic_slug":"best-practices-for-i2c-objects-drivers","display_username":"","primary_group_name":null,"primary_group_flair_url":null,"primary_group_flair_bg_color":null,"primary_group_flair_color":null,"version":2,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"link_counts":[{"url":"https://en.wikipedia.org/wiki/Load-link/store-conditional","internal":false,"reflection":false,"title":"Load-link/store-conditional - Wikipedia","clicks":2}],"read":true,"user_title":null,"reply_to_user":{"username":"deadsy","avatar_template":"/user_avatar/community.axoloti.com/deadsy/{size}/5105_1.png"},"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":967,"hidden":false,"hidden_reason_id":null,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":false,"wiki":false},{"id":31155,"name":"Jason T Harris","username":"deadsy","avatar_template":"/user_avatar/community.axoloti.com/deadsy/{size}/5105_1.png","created_at":"2018-10-25T01:15:43.011Z","cooked":"\u003cp\u003e\u003ca class=\"mention\" href=\"/u/smashedtransistors\"\u003e@SmashedTransistors\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eYes - lock free techniques are generally useful on both single core and multi-core devices. ChibiOS has the usual set of semaphores, mutexes, mailboxes, etc. used for data sharing between threads. All of them disable interrupts to lock out other threads and enforce the atomic sharing of data. Lock-less techniques don't lock out other threads, they can still run. The Cortex-M4 ISA provides load exclusive and store exclusive instructions used to implement lock-less data sharing.\u003c/p\u003e\n\n\u003cp\u003eNow: I wouldn't consider myself and expert at concurrent programming, and certainly not at lock-less sharing, but from what I understand getting lock-less right is tough. The conservative approach is probably to use the conventional locking primitives and see if that performs well enough. If yes - declare success. If no- then \u003cem\u003emaybe\u003c/em\u003e consider lock-less as an optimization.\u003c/p\u003e","post_number":8,"post_type":1,"updated_at":"2018-10-25T01:15:43.011Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"avg_time":21,"incoming_link_count":0,"reads":38,"score":8.65,"yours":false,"topic_id":5075,"topic_slug":"best-practices-for-i2c-objects-drivers","display_username":"Jason T Harris","primary_group_name":null,"primary_group_flair_url":null,"primary_group_flair_bg_color":null,"primary_group_flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":1672,"hidden":false,"hidden_reason_id":null,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":false,"wiki":false},{"id":31162,"name":"Mark Harris","username":"thetechnobear","avatar_template":"/user_avatar/community.axoloti.com/thetechnobear/{size}/6_1.png","created_at":"2018-10-25T09:22:33.777Z","cooked":"\u003cp\u003eyeah doing a proper lock free implementation is complex - but there are lots of freely available versions to use, usually in the form of a ring buffer. (as they also need to not allocate memory) \u003c/p\u003e\n\n\u003cp\u003eIve used them on other limited platforms (rPI/Organelle) to good effect, though ive not reviewed how much 'extra' memory they take , which may or may not be an issue with axoloti.\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003cp\u003ewhat I did for the midi ring buffer was simply to do it without locks (*), with detection for the read/write pointers crossing. but I was quite careful how I did the implementation, to ensure any theoretical thread contentions are minimised e.g. only writing in one thread - and making sure comparisons were very limited.\u003cbr\u003e(so your implementation has to be a bit more considered, than just taking out the locks - I know exactly where the possible thread contention are, how likely (minimal) , and the consequences  ) \u003c/p\u003e\n\n\u003cp\u003etheoretically I could have used 'test and set' atomic operations,  but I didn't because it doesn't really matter that much in this use case.\u003cbr\u003e if the ring-buffer is overflowing theres little you can do about it... its more than likely that the producer is still going to keep producing at a higher rate than consumer, so known 1 byte before or after doesn't really change the outcome \u003cimg src=\"//community.axoloti.com/images/emoji/twitter/wink.png?v=5\" title=\":wink:\" class=\"emoji\" alt=\":wink:\"\u003e \u003c/p\u003e\n\n\u003cp\u003ebasically its an optimistic strategy, where due to the ring buffer size, really it should not fail, and if it does its not the end of the world. ideally we would allow the user to optionally configure the ring buffer size, based on their needs.\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003cp\u003ein this example id suspect its similar, you can have a ring buffer which should never overrun  because you know the timing involved on the i2c and you know the timing of the event loop (k-rate).\u003cbr\u003eso under normal circumstances you know the max number of i2c events you expect in a k-rate cycle - and a bit more space for headroom and your done.\u003c/p\u003e\n\n\u003cp\u003ein someways I guess its a bit like setting the sample rate buffer size on a computer - you set it as low as you can go without experiencing issues\u003c/p\u003e\n\n\u003cp\u003eanyway, its just an idea - my personal preference is to avoid locks in the audio thread at all costs, as they invariable lead to little glitches when load increases,  which are really hard to track down later.\u003c/p\u003e","post_number":9,"post_type":1,"updated_at":"2018-10-25T09:29:54.203Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"avg_time":21,"incoming_link_count":0,"reads":38,"score":8.65,"yours":false,"topic_id":5075,"topic_slug":"best-practices-for-i2c-objects-drivers","display_username":"Mark Harris","primary_group_name":null,"primary_group_flair_url":null,"primary_group_flair_bg_color":null,"primary_group_flair_color":null,"version":2,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"actions_summary":[],"moderator":true,"admin":true,"staff":true,"user_id":5,"hidden":false,"hidden_reason_id":null,"trust_level":4,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":false,"wiki":false}],"stream":[31081,31083,31091,31092,31094,31133,31154,31155,31162]},"timeline_lookup":[[1,823],[3,822],[6,820],[7,819],[9,818]],"id":5075,"title":"Best Practices for I2C Objects/Drivers","fancy_title":"Best Practices for I2C Objects/Drivers","posts_count":9,"created_at":"2018-10-20T17:18:08.618Z","views":980,"reply_count":2,"participant_count":3,"like_count":7,"last_posted_at":"2018-10-25T09:22:33.777Z","visible":true,"closed":false,"archived":false,"has_summary":false,"archetype":"regular","slug":"best-practices-for-i2c-objects-drivers","category_id":16,"word_count":2184,"deleted_at":null,"user_id":1672,"pm_with_non_human_user":false,"draft":null,"draft_key":"topic_5075","draft_sequence":null,"unpinned":null,"pinned_globally":false,"pinned":false,"pinned_at":null,"pinned_until":null,"details":{"created_by":{"id":1672,"username":"deadsy","avatar_template":"/user_avatar/community.axoloti.com/deadsy/{size}/5105_1.png"},"last_poster":{"id":5,"username":"thetechnobear","avatar_template":"/user_avatar/community.axoloti.com/thetechnobear/{size}/6_1.png"},"participants":[{"id":1672,"username":"deadsy","avatar_template":"/user_avatar/community.axoloti.com/deadsy/{size}/5105_1.png","post_count":4,"primary_group_name":null,"primary_group_flair_url":null,"primary_group_flair_color":null,"primary_group_flair_bg_color":null},{"id":5,"username":"thetechnobear","avatar_template":"/user_avatar/community.axoloti.com/thetechnobear/{size}/6_1.png","post_count":3,"primary_group_name":null,"primary_group_flair_url":null,"primary_group_flair_color":null,"primary_group_flair_bg_color":null},{"id":967,"username":"SmashedTransistors","avatar_template":"/user_avatar/community.axoloti.com/smashedtransistors/{size}/3147_1.png","post_count":2,"primary_group_name":null,"primary_group_flair_url":null,"primary_group_flair_color":null,"primary_group_flair_bg_color":null}],"suggested_topics":[{"id":6393,"title":"Write 16 bools to a single index of a 16 bit table question!","fancy_title":"Write 16 bools to a single index of a 16 bit table question!","slug":"write-16-bools-to-a-single-index-of-a-16-bit-table-question","posts_count":10,"reply_count":3,"highest_post_number":10,"image_url":null,"created_at":"2020-02-08T16:25:11.974Z","last_posted_at":"2020-02-11T07:02:00.311Z","bumped":true,"bumped_at":"2020-02-11T07:02:00.311Z","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"archetype":"regular","like_count":5,"views":303,"category_id":16,"tags":[],"featured_link":null,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":745,"username":"jaffasplaffa","avatar_template":"/user_avatar/community.axoloti.com/jaffasplaffa/{size}/5808_1.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":1532,"username":"Captain_Burek","avatar_template":"/letter_avatar_proxy/v2/letter/c/90db22/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":2111,"username":"tele_player","avatar_template":"/letter_avatar_proxy/v2/letter/t/e47c2d/{size}.png"}}]},{"id":6569,"title":"Saving SRAM with 'no inline'","fancy_title":"Saving SRAM with \u0026lsquo;no inline\u0026rsquo;","slug":"saving-sram-with-no-inline","posts_count":4,"reply_count":1,"highest_post_number":4,"image_url":"/uploads/default/original/2X/4/4d52e39dc6c2849f55c4a309785f9baac6059501.PNG","created_at":"2020-04-17T20:46:07.225Z","last_posted_at":"2020-04-25T22:11:02.280Z","bumped":true,"bumped_at":"2020-04-25T22:11:02.280Z","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"archetype":"regular","like_count":8,"views":248,"category_id":16,"tags":[],"featured_link":null,"posters":[{"extras":null,"description":"Original Poster","user":{"id":384,"username":"rbrt","avatar_template":"/user_avatar/community.axoloti.com/rbrt/{size}/1907_1.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":2249,"username":"aRNo","avatar_template":"/letter_avatar_proxy/v2/letter/a/a5b964/{size}.png"}},{"extras":"latest","description":"Most Recent Poster","user":{"id":2480,"username":"jcgriggs","avatar_template":"/letter_avatar_proxy/v2/letter/j/9e8a1a/{size}.png"}}]},{"id":6523,"title":"Biquad Filters: How to do LP ↔︎ Bypass ↔︎ HP","fancy_title":"Biquad Filters: How to do LP :left_right_arrow:︎ Bypass :left_right_arrow:︎ HP","slug":"biquad-filters-how-to-do-lp-bypass-hp","posts_count":6,"reply_count":2,"highest_post_number":6,"image_url":null,"created_at":"2020-03-30T23:10:45.170Z","last_posted_at":"2020-04-01T00:06:35.972Z","bumped":true,"bumped_at":"2020-04-01T00:06:35.972Z","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"archetype":"regular","like_count":4,"views":272,"category_id":16,"tags":[],"featured_link":null,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":2511,"username":"bolau","avatar_template":"/letter_avatar_proxy/v2/letter/b/ecd19e/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":337,"username":"Blindsmyth","avatar_template":"/letter_avatar_proxy/v2/letter/b/2acd7d/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":1736,"username":"borututuforte","avatar_template":"/user_avatar/community.axoloti.com/borututuforte/{size}/5671_1.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":772,"username":"patatos","avatar_template":"/letter_avatar_proxy/v2/letter/p/5f9b8f/{size}.png"}}]},{"id":6534,"title":"Sram overhead thorugh mod source code in subpatches?","fancy_title":"Sram overhead thorugh mod source code in subpatches?","slug":"sram-overhead-thorugh-mod-source-code-in-subpatches","posts_count":8,"reply_count":6,"highest_post_number":8,"image_url":"/uploads/default/optimized/2X/6/6b34f91d90519ba99485c71ba2cacb745a725708_1_690x322.jpg","created_at":"2020-04-04T15:24:41.532Z","last_posted_at":"2020-04-15T20:43:49.394Z","bumped":true,"bumped_at":"2020-04-15T20:43:49.394Z","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"archetype":"regular","like_count":3,"views":271,"category_id":16,"tags":[],"featured_link":null,"posters":[{"extras":null,"description":"Original Poster","user":{"id":337,"username":"Blindsmyth","avatar_template":"/letter_avatar_proxy/v2/letter/b/2acd7d/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":2121,"username":"weasel79","avatar_template":"/user_avatar/community.axoloti.com/weasel79/{size}/6141_1.png"}},{"extras":"latest","description":"Most Recent Poster","user":{"id":384,"username":"rbrt","avatar_template":"/user_avatar/community.axoloti.com/rbrt/{size}/1907_1.png"}}]},{"id":6599,"title":"How do I get more than 16 voice polyphony?","fancy_title":"How do I get more than 16 voice polyphony?","slug":"how-do-i-get-more-than-16-voice-polyphony","posts_count":7,"reply_count":1,"highest_post_number":7,"image_url":null,"created_at":"2020-05-01T22:39:48.983Z","last_posted_at":"2020-05-02T15:33:30.795Z","bumped":true,"bumped_at":"2020-05-02T15:33:30.795Z","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"archetype":"regular","like_count":6,"views":253,"category_id":16,"tags":[],"featured_link":null,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":745,"username":"jaffasplaffa","avatar_template":"/user_avatar/community.axoloti.com/jaffasplaffa/{size}/5808_1.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":139,"username":"sebiiksbcs","avatar_template":"/user_avatar/community.axoloti.com/sebiiksbcs/{size}/6295_1.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":410,"username":"SirSickSik","avatar_template":"/user_avatar/community.axoloti.com/sirsicksik/{size}/5014_1.png"}}]}],"links":[{"url":"https://github.com/axoloti/axoloti-contrib/tree/1.0.12/objects/deadsy/mpr121","title":"axoloti-contrib/objects/deadsy/mpr121 at 1.0.12 · axoloti/axoloti-contrib · GitHub","fancy_title":null,"internal":false,"attachment":false,"reflection":false,"clicks":44,"user_id":1672,"domain":"github.com"},{"url":"https://github.com/axoloti/axoloti-contrib/tree/1.0.12/objects/deadsy/ttp229","title":"axoloti-contrib/objects/deadsy/ttp229 at 1.0.12 · axoloti/axoloti-contrib · GitHub","fancy_title":null,"internal":false,"attachment":false,"reflection":false,"clicks":25,"user_id":1672,"domain":"github.com"},{"url":"https://en.wikipedia.org/wiki/I%C2%B2C","title":"I²C - Wikipedia","fancy_title":null,"internal":false,"attachment":false,"reflection":false,"clicks":8,"user_id":1672,"domain":"en.wikipedia.org"},{"url":"http://www.chibios.org/dokuwiki/doku.php?id=chibios:book:kernel_mailboxes","title":"ChibiOS free embedded RTOS - RT Mailboxes","fancy_title":null,"internal":false,"attachment":false,"reflection":false,"clicks":4,"user_id":1672,"domain":"www.chibios.org"},{"url":"https://en.wikipedia.org/wiki/Load-link/store-conditional","title":"Load-link/store-conditional - Wikipedia","fancy_title":null,"internal":false,"attachment":false,"reflection":false,"clicks":2,"user_id":967,"domain":"en.wikipedia.org"},{"url":"http://community.axoloti.com/t/spi-i2c-oled-display/638/150","title":"SPI/I2C OLED display","fancy_title":null,"internal":true,"attachment":false,"reflection":true,"clicks":0,"user_id":967,"domain":"community.axoloti.com"}],"notification_level":1,"can_flag_topic":false},"highest_post_number":9,"deleted_by":null,"actions_summary":[{"id":4,"count":0,"hidden":false,"can_act":false},{"id":7,"count":0,"hidden":false,"can_act":false},{"id":8,"count":0,"hidden":false,"can_act":false}],"chunk_size":20,"bookmarked":null,"tags":[],"featured_link":null,"topic_timer":null,"message_bus_last_id":68});
      })();
      </script>

    

    <script>
  Ember.RSVP.configure('onerror', function(e) {
    // Ignore TransitionAborted exceptions that bubble up
    if (e && e.message === "TransitionAborted") { return; }

    window.onerror(e && e.message, null,null,null,e);
  });
</script>

<script>

  (function() {
    var ps = require('preload-store').default;

    Discourse.CDN = '';
    Discourse.BaseUrl = 'community.axoloti.com'.replace(/:[\d]*$/,"");
    Discourse.BaseUri = '';
    Discourse.Environment = 'production';
    Discourse.SiteSettings = ps.get('siteSettings');
    Discourse.LetterAvatarVersion = '5_9b142ce9460b8c6b265fd9abf598d3fd';
    I18n.defaultLocale = 'en';
    Discourse.start();
    Discourse.set('assetVersion','d1ec72c862674d2eea0eb8ef6fc5934f');
    Discourse.Session.currentProp("disableCustomCSS", false);
    Discourse.HighlightJSPath = "/highlight-js/community.axoloti.com/100444ceef8ca161334f64d3ce49fe7a1556f943.js";
  })();
</script>

<link rel='preload' href='/assets/browser-update-f57286e74ddbc53aa899689b01ef467078911e4138050c561939955849af35dd.js' as='script'/>
<script src='/assets/browser-update-f57286e74ddbc53aa899689b01ef467078911e4138050c561939955849af35dd.js'></script>


    

      
    
  </body>
</html>
