<!DOCTYPE html>
<html lang="en">
  
<!-- Mirrored from community.axoloti.com/t/inserting-patch-code-into-main-fw-code/2382 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 10 Jul 2023 16:03:44 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Inserting patch code into main FW code - Developer - Axoloti Community</title>
    <meta name="description" content="Hi All 

finally I get - maybe in a week from now - some time to spend on the AXO board. I already stated that my purpose with the board is to learn the ropes of programming the STM32 for audio applications, so I plan to&amp;hellip;">
    <meta name="author" content="">
<meta name="generator" content="Discourse 1.9.0.beta3 - https://github.com/discourse/discourse version 13f3de4bf673802eb8ec595d36587b4524773209">
<link rel="icon" type="image/png" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<link rel="icon" sizes="144x144" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<link rel="canonical" href="2382.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"http://community.axoloti.com","potentialAction":{"@type":"SearchAction","target":"http://community.axoloti.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="Axoloti Community Search">

        <link href="../../stylesheets/desktop_d93a33ca8617326fe353f80e6ab865188244d48c8e0b.css?__ws=community.axoloti.com" media="all" rel="stylesheet" data-target="desktop"/>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','../../../www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56017691-4', {"cookieDomain":"auto"});
</script>

      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Inserting patch code into main FW code&#39;" href="2382.rss" />
  <meta property="og:site_name" content="Axoloti Community" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="http://community.axoloti.com/uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png" />
<meta property="og:image" content="http://community.axoloti.com/uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png" />
<meta property="og:url" content="http://community.axoloti.com/t/inserting-patch-code-into-main-fw-code/2382" />
<meta name="twitter:url" content="http://community.axoloti.com/t/inserting-patch-code-into-main-fw-code/2382" />
<meta property="og:title" content="Inserting patch code into main FW code" />
<meta name="twitter:title" content="Inserting patch code into main FW code" />
<meta property="og:description" content="Hi All   finally I get - maybe in a week from now - some time to spend on the AXO board. I already stated that my purpose with the board is to learn the ropes of programming the STM32 for audio applications, so I plan to leverage the written code and study it to learn how to deal with the controller and its peripherals.   Last time I managed to compile the FW as makefile project using gnu tool chain under Eclipse, adding some very stylish LED blinking of my own ðŸ˜ ðŸ˜‚   Now my goal is to s..." />
<meta name="twitter:description" content="Hi All   finally I get - maybe in a week from now - some time to spend on the AXO board. I already stated that my purpose with the board is to learn the ropes of programming the STM32 for audio applications, so I plan to leverage the written code and study it to learn how to deal with the controller and its peripherals.   Last time I managed to compile the FW as makefile project using gnu tool chain under Eclipse, adding some very stylish LED blinking of my own ðŸ˜ ðŸ˜‚   Now my goal is to s..." />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="1 mins ðŸ•‘" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="1 â¤" />


  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html"><img src="../../uploads/default/original/1X/b22e6e9ef608f1e17a1de19b733d043beff77f05.png" alt="Axoloti Community" id="site-logo" style="max-width: 150px;"></a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1>
  <a href="2382.html">Inserting patch code into main FW code</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/developer.html" itemprop="url">
        <span itemprop="title">Developer</span>
      </a>
    </div>
</div>





<hr>


  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/MikeAnblips.html'><b itemprop='author'>MikeAnblips</b></a>
           
           <time datetime='2016-10-12T21:10:08Z' itemprop='datePublished'>
             2016-10-12 21:10:08 UTC
           </time>
        </span>
        <span itemprop='position'>#1</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Hi All</p>

<p>finally I get - maybe in a week from now - some time to spend on the AXO board.<br>I already stated that my purpose with the board is to learn the ropes of programming the STM32 for audio applications, so I plan to leverage the written code and study it to learn how to deal with the controller and its peripherals.</p>

<p>Last time I managed to compile the FW as makefile project using gnu tool chain under Eclipse, adding some very stylish LED blinking of my own <img src="../../images/emoji/emoji_one/grin30f4.png?v=3" title=":grin:" class="emoji" alt=":grin:"> <img src="../../images/emoji/emoji_one/joy30f4.png?v=3" title=":joy:" class="emoji" alt=":joy:"></p>

<p>Now my goal is to start working on basic filtering actions, with the easiest filter being a straight connection between IN and OUT.</p>

<p>This involves sending to and getting back data from the DAC/ADC, through SPI interface.<br>Since I wouldn't really know where to start with this, I thought I would put a simple patch together using the GUI, where a single in and out audio blocks are connected by a wire, and then try to embed its code (which is available in the file patch.cpp) somehow in the main of the FW.</p>

<p>However, I am not able to do so because it looks like the patch loading mechanism is different than a simple loading of functions...At least I wasn't able to figure out the proper actions to follow.</p>

<p>Can anyone point me in the right direction?</p>

<p>Alternatively, what is the simplest form of (DMA) transfer to and back from the ADC/DAC via SPI, using AXO?</p>

<p>Thank you in advance for any hint <img src="../../images/emoji/emoji_one/smile30f4.png?v=3" title=":smile:" class="emoji" alt=":smile:"></p>

<p>Michele</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='Inserting patch code into main FW code'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/johannes.html'><b itemprop='author'>johannes</b></a>
           
           <time datetime='2016-10-13T00:50:48Z' itemprop='datePublished'>
             2016-10-13 00:50:48 UTC
           </time>
        </span>
        <span itemprop='position'>#2</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>The "bible" for programming the processor is the RM0090 Reference manual from STMicro. It's a heavy document, over 1700 pages... PM0214 is also interesting, and the STM32F427 datasheet.<br>Let me first explain why splitting firmware and patch is interesting: if you 'd compile and flash both parts together, it takes far more time to flash. Erasing/writing the whole flash memory is slow, and can't keep a usb connection alive that way. Splitting firmware and patch keeps the compilation and upload time fast for the patch, while firmware is less likely to change as often.<br>The patch is compiled as a separate binary from the firmware, but can use exposed firmware functions and variable via hard linking though the --just-symbols linker flag. The patch main function returns a patchMeta_t struct containing the relevant callbacks.<br>The DAC/ADC does not use the SPI peripheral in the processor, but the SAI, it is more specialized for audio i/o. The codec register and DMA initialization is in <code>firmware/codec_ADAU1961_SAI.c</code>.<br>A DMA interrupt from SAI then wakes up the "ThreadDSP" thread in <code>firmware/patch.c</code> which in turn calls the patchMeta.fptr_dsp_process callback. </p>

<p>You can strip the firmware to bypass patch loading, but I'd suggest to have a look at the object editor in the Axoloti GUI. It accelerates code development, because it makes the edit/compile/evaluate cycle quite fast, and allows to validate algorithms-in-development with a variety of signal generators, and inspect the real-time output.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:1'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Inserting patch code into main FW code'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/MikeAnblips.html'><b itemprop='author'>MikeAnblips</b></a>
           
           <time datetime='2016-10-13T08:40:14Z' itemprop='datePublished'>
             2016-10-13 08:40:14 UTC
           </time>
        </span>
        <span itemprop='position'>#3</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Hi Johannes</p>

<p>Thanks, lots of good pointers in your answer.<br>Sure I've got the Bible as you call it, but as we stated elsewhere, there is no "learn STM" book out there, there is no path laid out for the general user. So I'm trying to see if I can build one of my own, with the limited time I have on my hands.</p>

<p>No questions about the usefulness of loading a test module <em>only</em> as opposed to uploading the whole infrastructure time and again.</p>

<p>I will look into your pointers:</p>

<ol>
<li>the struct of callbacks returned by <code>main()</code> in <code>patch.cpp</code>
</li>
<li>the <code>patchMeta.fptr_dsp_process</code> callback specifically</li>
<li>the <code>--just-symbols</code> flag (which is totally obscure to me)</li>
<li>SAI peripherial and its related initialization in <code>firmare/codec_ADAU1961_SAI.c</code>
</li>
</ol>

<p>I think I understand your final comment: from a perspective of developing algorithms, the AXO GUI is the real deal. You can just connect your blocks the way it visually makes sense and upload them in real time to see the effects.<br>This is a really powerful approach and I understand that a lot of work went into providing this infrastructure.</p>

<p>Before I get to that, however, I am interested in getting a first-pass understanding of the "guts" of the processing.<br>My key focus is <strong>not</strong> in algorithm creation right now, but in being able to understand the basics of data transfers firstly to and from the ADC/DAC, then (but I guess this will be easier) to other peripherals like I/O for "live" switching, MIDI and the like..</p>

<p>Thanks a lot for your help, I really appreciate your comments so...Keep them coming! <img src="../../images/emoji/emoji_one/innocent30f4.png?v=3" title=":innocent:" class="emoji" alt=":innocent:"></p>

<p>Michele</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='Inserting patch code into main FW code'>
      <hr>
  </div>






    </div>
    <footer class="container">
      <nav itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <a href='../../index.html'>Home</a>
        <a href="../../categories.html">Categories</a>
        <a href="../../guidelines.html">FAQ/Guidelines</a>
        <a href="../../tos.html">Terms of Service</a>
        <a href="../../privacy.html">Privacy Policy</a>
      </nav>
      <p>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
    
  </body>
  

<!-- Mirrored from community.axoloti.com/t/inserting-patch-code-into-main-fw-code/2382 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 10 Jul 2023 16:03:44 GMT -->
</html>
