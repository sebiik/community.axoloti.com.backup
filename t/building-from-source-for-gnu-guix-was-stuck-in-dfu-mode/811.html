<!DOCTYPE html>
<html lang="en">
  
<!-- Mirrored from community.axoloti.com/t/building-from-source-for-gnu-guix-was-stuck-in-dfu-mode/811 by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 19 Jul 2023 03:57:13 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Building from source for GNU Guix (was: Stuck in DFU mode) - Helpdesk - Axoloti Community</title>
    <meta name="description" content="I&amp;#39;ve built the cross-compiler toolchain and the Axoloti software on GNU Guix, but so far have not been able to successfully upload a patch (as reported here https://github.com/axoloti/axoloti/issues/267). 

Everything lo&amp;hellip;">
    <meta name="author" content="">
<meta name="generator" content="Discourse 1.9.0.beta3 - https://github.com/discourse/discourse version 13f3de4bf673802eb8ec595d36587b4524773209">
<link rel="icon" type="image/png" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<link rel="icon" sizes="144x144" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<link rel="canonical" href="811.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://sebiik.github.io/community.axoloti.com.backup","potentialAction":{"@type":"SearchAction","target":"https://sebiik.github.io/community.axoloti.com.backup/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="Axoloti Community Search">

        <link href="../../stylesheets/desktop_d93a33ca8617326fe353f80e6ab865188244d48c8e0b.css?__ws=community.axoloti.com" media="all" rel="stylesheet" data-target="desktop"/>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','../../../www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56017691-4', {"cookieDomain":"auto"});
</script>

      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Building from source for GNU Guix (was: Stuck in DFU mode)&#39;" href="811-2.html" />
  <meta property="og:site_name" content="Axoloti Community" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://sebiik.github.io/community.axoloti.com.backup/uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png" />
<meta property="og:image" content="https://sebiik.github.io/community.axoloti.com.backup/uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png" />
<meta property="og:url" content="https://sebiik.github.io/community.axoloti.com.backup/t/building-from-source-for-gnu-guix-was-stuck-in-dfu-mode/811" />
<meta name="twitter:url" content="https://sebiik.github.io/community.axoloti.com.backup/t/building-from-source-for-gnu-guix-was-stuck-in-dfu-mode/811" />
<meta property="og:title" content="Building from source for GNU Guix (was: Stuck in DFU mode)" />
<meta name="twitter:title" content="Building from source for GNU Guix (was: Stuck in DFU mode)" />
<meta property="og:description" content="I&#39;ve built the cross-compiler toolchain and the Axoloti software on GNU Guix, but so far have not been able to successfully upload a patch (as reported here https://github.com/axoloti/axoloti/issues/267).   Everything looks fine and the logs state that chunks are uploaded, but every time it reports a firmware CRC mismatch.  So I thought that maybe I should try uploading the firmware via DFU mode and I disconnected the device, pressed S1, reconnected, and the device appeared in DFU mode:   Bus 00..." />
<meta name="twitter:description" content="I&#39;ve built the cross-compiler toolchain and the Axoloti software on GNU Guix, but so far have not been able to successfully upload a patch (as reported here https://github.com/axoloti/axoloti/issues/267).   Everything looks fine and the logs state that chunks are uploaded, but every time it reports a firmware CRC mismatch.  So I thought that maybe I should try uploading the firmware via DFU mode and I disconnected the device, pressed S1, reconnected, and the device appeared in DFU mode:   Bus 00..." />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="5 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="6 ❤" />

      <link rel="next" href="8114658.html?page=2">

  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html"><img src="../../uploads/default/original/1X/b22e6e9ef608f1e17a1de19b733d043beff77f05.png" alt="Axoloti Community" id="site-logo" style="max-width: 150px;"></a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1>
  <a href="811.html">Building from source for GNU Guix (was: Stuck in DFU mode)</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/helpdesk.html" itemprop="url">
        <span itemprop="title">Helpdesk</span>
      </a>
    </div>
</div>





<hr>


  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/rekado.html'><b itemprop='author'>rekado</b></a>
           
           <time datetime='2016-01-02T13:02:20Z' itemprop='datePublished'>
             2016-01-02 13:02:20 UTC
           </time>
        </span>
        <span itemprop='position'>#1</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>I've built the cross-compiler toolchain and the Axoloti software on GNU Guix, but so far have not been able to successfully upload a patch (as reported here <a href="https://github.com/axoloti/axoloti/issues/267" rel="nofollow">https://github.com/axoloti/axoloti/issues/267</a>).</p>

<p>Everything looks fine and the logs state that chunks are uploaded, but every time it reports a firmware CRC mismatch.  So I thought that maybe I should try uploading the firmware via DFU mode and I disconnected the device, pressed S1, reconnected, and the device appeared in DFU mode:</p>

<p><code>Bus 006 Device 027: ID 0483:df11 SGS Thomson Microelectronics STM Device in DFU Mode</code></p>

<p>So I selected Board -&gt; Firmware -&gt; Flash (Rescue) and observed dfu-util do its thing.  Here's the output:</p>

<pre><code>Copyright 2005-2009 Weston Schmidt, Harald Welte and OpenMoko Inc.
Copyright 2010-2014 Tormod Volden and Stefan Schmidt
This program is Free Software and has ABSOLUTELY NO WARRANTY
Please report bugs to dfu-util@lists.gnumonks.org

dfu-util: Invalid DFU suffix signature
dfu-util: A valid DFU suffix will be required in a future dfu-util release!!!
Opening DFU capable USB device...
ID 0483:df11
Run-time device DFU version 011a
Claiming USB DFU Interface...
Setting Alternate Setting #0 ...
Determining device status: state = dfuERROR, status = 10
dfuERROR, clearing status
Determining device status: state = dfuIDLE, status = 0
dfuIDLE, continuing
DFU mode device DFU version 011a
Device returned transfer size 2048
DfuSe interface name: "Internal Flash  "
Downloading to address = 0x08000000, size = 570468

Download	[                         ]   0%            0 bytes
...
Download	[============             ]  50%       288768 bytes
...
Download	[=========================] 100%       570468 bytes
Download done.
File downloaded successfully
Transitioning to dfuMANIFEST state
Done flashing firmware with DFU.</code></pre>

<p>Now upon disconnecting the board and connecting it again it seems to be dead.  lsusb does not show it, it does not power on, and the only way I can get it to reappear is by pressing S1 while connecting it.  It appears again in DFU mode and I can again flash the rescue firmware as before, but I cannot seem to get it back into normal mode again.</p>

<p>I'm not sure what's going on here.  In the regular mode uploading firmware had no effect (firmware CRC mismatch, no matter how often I flashed it) and in DFU mode flashing the firmware seems to not do anything either.</p>

<p>I have another board which is still in regular mode and it has the same issue with firmware CRC mismatch warnings, so I don't think it's a hardware problem.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
            <a href="../linux-mintppc-with-axoloti/859/2.html">Linux mintppc with axoloti?</a>
            <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/thetechnobear.html'><b itemprop='author'>thetechnobear</b></a>
           
           <time datetime='2016-01-02T13:19:11Z' itemprop='datePublished'>
             2016-01-02 13:19:11 UTC
           </time>
        </span>
        <span itemprop='position'>#2</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>if you built the environment yourself, I guess there is a potential you are using different versions of things like dfu-util and libusb (or other dependent libraries), which <strong>may</strong> cause issues. <br>this is unfortunately a general issue, developers cant test on every possibly combination of libraries... this is a problem with linux, given its plethora of distributions which different libs... and of course every user (me included) having their own 'favourite'</p>

<p>I think the 'obvious' one to check is libusb, and to ensure you apply the libusb patch ...  you will see the relevant line in build.sh</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:2'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/johannes.html'><b itemprop='author'>johannes</b></a>
           
           <time datetime='2016-01-02T13:23:40Z' itemprop='datePublished'>
             2016-01-02 13:23:40 UTC
           </time>
        </span>
        <span itemprop='position'>#3</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Are you using the same arm-none-eabi-gcc version as in the build script to build the firmware (gcc-arm-none-eabi-4_9-2015q2-20150609)?</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/thetechnobear.html'><b itemprop='author'>thetechnobear</b></a>
           
           <time datetime='2016-01-02T13:26:03Z' itemprop='datePublished'>
             2016-01-02 13:26:03 UTC
           </time>
        </span>
        <span itemprop='position'>#4</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote" data-post="1" data-topic="811"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/rekado/40/1059_1.html" class="avatar">rekado:</div>
<blockquote><p>dfu-util: Invalid DFU suffix signature<br>dfu-util: A valid DFU suffix will be required in a future dfu-util release!!!<br>Opening DFU capable USB device...<br>ID 0483:df11<br>Run-time device DFU version 011a<br>Claiming USB DFU Interface...<br>Setting Alternate Setting #0 ...<br>Determining device status: state = dfuERROR, status = 10<br>dfuERROR, clearing status</p></blockquote></aside>

<p>ok, dont worry about these 'errors' I get these too.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/johannes.html'><b itemprop='author'>johannes</b></a>
           
           <time datetime='2016-01-02T13:27:22Z' itemprop='datePublished'>
             2016-01-02 13:27:22 UTC
           </time>
        </span>
        <span itemprop='position'>#5</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote" data-post="2" data-topic="811"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/thetechnobear/40/6_1.png" class="avatar">thetechnobear:</div>
<blockquote><p>the libusb patch</p></blockquote></aside>

<p>missing the libusb patch 'd only cause dfu-util to fail (issue with the rom bootloader in stm32f42x series), but that looks fine in <a class="mention" href="../../users/rekado.html">@rekado</a>'s log</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/rekado.html'><b itemprop='author'>rekado</b></a>
           
           <time datetime='2016-01-02T13:28:07Z' itemprop='datePublished'>
             2016-01-02 13:28:07 UTC
           </time>
        </span>
        <span itemprop='position'>#6</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>I have applied the patch to the upstream sources of libusb 1.0.19.  I used the patched version of libusb as an input to "dfu-util" version 0.8.</p>

<p>I followed the build.sh as closely as possible.  I did not pass USB_LIBS and USB_CFLAGS during the configuration phase of dfu-util because there is only the patched version of libusb around at build time (Guix packages are built in a chroot where only declared inputs are visible).</p>

<p>(One additional configure flag that I pass to libusb is "--disable-udev" because uedev depends on libusb indirectly.)</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/rekado.html'><b itemprop='author'>rekado</b></a>
           
           <time datetime='2016-01-02T13:32:15Z' itemprop='datePublished'>
             2016-01-02 13:32:15 UTC
           </time>
        </span>
        <span itemprop='position'>#7</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote" data-post="3" data-topic="811" data-full="true"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/johannes/40/8_1.png" class="avatar">johannes:</div>
<blockquote><p>Are you using the same arm-none-eabi-gcc version as in the build script to build the firmware (gcc-arm-none-eabi-4_9-2015q2-20150609)?</p></blockquote></aside>

<p>I'm not using the prebuilt gcc-arm-none-eabi distribution (primarily because it wouldn't work on my system).  I built the cross compiler (version 4.9.3 for target "arm-none-eabi") and the "newlib" C library (version 2.2.0) from scratch.  It compiles the firmware fine.</p>

<p>If it really is a problem with the firmware binary, would it be possible for you to share the binary firmware and let me try to upload that with dfu-util, rather than the firmware I built?</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/johannes.html'><b itemprop='author'>johannes</b></a>
           
           <time datetime='2016-01-02T13:34:52Z' itemprop='datePublished'>
             2016-01-02 13:34:52 UTC
           </time>
        </span>
        <span itemprop='position'>#8</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote" data-post="7" data-topic="811"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/rekado/40/1059_1.html" class="avatar">rekado:</div>
<blockquote><p>share the binary firmware</p></blockquote></aside>

<p>Could you extract it from the .deb package?</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/rekado.html'><b itemprop='author'>rekado</b></a>
           
           <time datetime='2016-01-02T13:35:21Z' itemprop='datePublished'>
             2016-01-02 13:35:21 UTC
           </time>
        </span>
        <span itemprop='position'>#9</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote" data-post="8" data-topic="811"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/johannes/40/8_1.png" class="avatar">johannes:</div>
<blockquote><p>Could you extract it from the .deb package?</p></blockquote></aside>

<p>Oh, yes, I could try that.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/rekado.html'><b itemprop='author'>rekado</b></a>
           
           <time datetime='2016-01-02T13:57:28Z' itemprop='datePublished'>
             2016-01-02 13:57:28 UTC
           </time>
        </span>
        <span itemprop='position'>#10</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>It worked with the firmware contained in the .deb package.</p>

<p>That's both good and bad.  "Good" because the board is back to normal mode, "bad" because it means that my cross-compiler doesn't quite produce the correct binaries (although it seems to be very close).</p>

<p>At least I'm sure now that dfu-util works as it should, and that the boards are not broken <img src="../../images/emoji/emoji_one/smilea4f0.png?v=0" title=":smile:" class="emoji" alt=":smile:"></p>

<p>I would love to figure out what the difference between the two compilers or C libraries is (and the produced binaries).  I'll investigate.</p>

<p>Thanks for the assistance so far!</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/rekado.html'><b itemprop='author'>rekado</b></a>
           
           <time datetime='2016-01-02T14:15:59Z' itemprop='datePublished'>
             2016-01-02 14:15:59 UTC
           </time>
        </span>
        <span itemprop='position'>#11</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote" data-post="10" data-topic="811"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/rekado/40/1059_1.html" class="avatar">rekado:</div>
<blockquote><p>I would love to figure out what the difference between the two compilers or C libraries is (and the produced binaries).  I'll investigate.</p></blockquote></aside>

<p>One obvious difference is that I used the regular GCC 4.9.3 sources, but the binary compiler toolchain (gcc-arm-none-eabi-4_9-2015q2-20150609) is based on a different branch of the GCC sources: <a href="https://gcc.gnu.org/svn/gcc/branches/ARM/embedded-4_9-branch/" rel="nofollow">https://gcc.gnu.org/svn/gcc/branches/ARM/embedded-4_9-branch/</a> at revision 224288.</p>

<p>I'll rebuild the cross-compiler with these sources; maybe that's enough to fix it.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/rekado.html'><b itemprop='author'>rekado</b></a>
           
           <time datetime='2016-01-03T20:58:53Z' itemprop='datePublished'>
             2016-01-03 20:58:53 UTC
           </time>
        </span>
        <span itemprop='position'>#12</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>I rebuilt the cross-compiler using the exact same SVN branch and revision, but unfortunately the behaviour is unchanged.  Maybe it's not the compiler that is to be blamed but differences in newlib?</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/johannes.html'><b itemprop='author'>johannes</b></a>
           
           <time datetime='2016-01-03T21:07:53Z' itemprop='datePublished'>
             2016-01-03 21:07:53 UTC
           </time>
        </span>
        <span itemprop='position'>#13</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Don't know, haven't ever built arm-none-eabi-gcc myself. What prevents running the gcc-arm-none-eabi distribution?</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/rekado.html'><b itemprop='author'>rekado</b></a>
           
           <time datetime='2016-01-03T22:11:29Z' itemprop='datePublished'>
             2016-01-03 22:11:29 UTC
           </time>
        </span>
        <span itemprop='position'>#14</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>GuixSD doesn't follow the FHS to provide functional package management as well as stateless and declarative system configuration.  Prebuilt binaries won't work as they expect certain libraries to be located in well-known locations.  To make matters worse, I don't think I can easily get a 32 bit glibc on my 64 bit system (the glibc that comes with GuixSD doesn't currently support multilib).</p>

<p>That's why it's easier for me to build the compiler toolchain from source (Guix makes this pretty simple, actually).  The compiler does seem to work (i.e. it builds ARM binaries and links them successfully), but Axoloti claims that the CRC after uploading via dfu-util differs.  I find this rather odd.</p>

<p>I'll try to use the very same commit of "newlib" that is mentioned in the release.txt of the prebuilt gcc-arm-none-eabi tarball next, but I feel I'm soon running out of options.  Maybe diffing the produced binaries themselves will shed some light on what's going on.</p>

<p>How is the hardware CRC computed?  It seems to be the result of something transmitted via USB, but I don't understand the code well enough to know where it really comes from.</p>

<p>What is "firmware/flasher/flasher_build/flasher.bin" used for?  Exactly what binaries are uploaded to the board?  Is there some documentation about this or would it be better if I read the code?</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/johannes.html'><b itemprop='author'>johannes</b></a>
           
           <time datetime='2016-01-03T22:43:12Z' itemprop='datePublished'>
             2016-01-03 22:43:12 UTC
           </time>
        </span>
        <span itemprop='position'>#15</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>I have no clue about Guix, if you say prebuilt gcc won't work I totally believe you <img src="../../images/emoji/emoji_one/smilea4f0.png?v=0" title=":smile:" class="emoji" alt=":smile:"></p>

<p>Firmware computes crc32 from internal flash when booting on the microcontroller (in firmware/pconnection.c, in InitPConnection), the GUI computes the crc32 from the file firmware/build/axoloti.bin</p>

<p>They're verified, and also a patch launched will verify, since a mismatch can cause crashes (of just the board, and non-destructive), since firmware symbols could have moved.</p>

<p>firmware/flasher is a binary that loads via the same mechanism as a patch, but rather than being linked to the firmware, it is fully self-contained so it can erase/write a new firmware. This is used in the GUI in the firmware update process.</p>

<p>If you have managed to compile and upload a firmware with your self-compiled gcc, you're pretty close! The crc mismatch, that could come from different padding by the dfu-upload or something. Perhaps do a binary firmware <em>download</em> with dfu-util, and check a binary diff. I also get crc mismatches when launching firmware via gdb/openocd/stlink but haven't studied the origin. In this situation I bypass the patch-firmware crc validation (axoloti/src/main/java/axoloti/Patch.java , remove line 1199 with the return statement).</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/rekado.html'><b itemprop='author'>rekado</b></a>
           
           <time datetime='2016-01-04T19:50:41Z' itemprop='datePublished'>
             2016-01-04 19:50:41 UTC
           </time>
        </span>
        <span itemprop='position'>#16</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>I downloaded the firmware from the board with dfu-util and indeed there are a couple of difference between the file and axoloti.bin.</p>

<p>A common change is that the downloaded file has hex "0000 0000" where axoloti.bin has "aff3 0080".  According to <a href="http://armconverter.com/conversions.php" rel="nofollow">this page</a> the latter is Thumb-2 hex for <code>NOP.W</code>; don't know why it would be replaced with all zeros upon uploading the firmware.</p>

<p>Yet another often repeated change is from <code>682f</code> (axoloti.bin) to <code>482f</code> (on board).</p>

<p>There are a few other minor changes, but they don't appear to have a simple pattern.  It's often just a change of a single 32 bit word.  I wonder what would cause this change when uploading the binary.</p>

<p>I tried uploading the firmware bundled with the .deb archive and see if there's any differences when downloading it from the board.  (Just as a sanity check.)  There are no such differences in the first 2^14 bytes, so I assume the file stays the same.</p>

<hr>

<p>EDIT: I compared both the original firmware bundled with the .deb and the firmware I downloaded from the board --- and they are the same!  This strongly suggests that my self-compiled firmware was never successfully uploaded.  I will try uploading my custom firmware from the command line via dfu-util.</p>

<p>EDIT: this does work, but the board is stuck in DFU mode again.  The differences I noted above are, in fact, between my self-built firmware and the bundled pre-compiled firmware.  I'm surprised to see how similar the two are.  I'll try to figure out what causes the differences --- and which of them are important.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:2'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/rekado.html'><b itemprop='author'>rekado</b></a>
           
           <time datetime='2016-01-04T21:15:44Z' itemprop='datePublished'>
             2016-01-04 21:15:44 UTC
           </time>
        </span>
        <span itemprop='position'>#17</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>The first question I'd like to answer is: why does it look like my firmware is uploaded to the board (when in normal mode), but the board never actually retains it?</p>

<p>Whenever I download firmware from the board it is the one version that I successfully uploaded: the one bundled with the .deb archive.</p>

<p>Uploading my firmware in DFU mode causes the board to "die"; <code>lsusb</code> doesn't show that it's connected.  Why doesn't this happen when I upload it via the GUI in normal mode?</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:2'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/rekado.html'><b itemprop='author'>rekado</b></a>
           
           <time datetime='2016-01-04T22:17:56Z' itemprop='datePublished'>
             2016-01-04 22:17:56 UTC
           </time>
        </span>
        <span itemprop='position'>#18</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Quick update: replacing the firmware directory with the one that's bundled in the .deb file I can compile patches and upload them to the board --- and I actually get sound!</p>

<p>So, the compiler seems to work, but the firmware I built is broken.</p>

<p>(The board is lovely and the sound is great!)</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:1'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/johannes.html'><b itemprop='author'>johannes</b></a>
           
           <time datetime='2016-01-04T22:31:40Z' itemprop='datePublished'>
             2016-01-04 22:31:40 UTC
           </time>
        </span>
        <span itemprop='position'>#19</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Maybe diff the output from arm-none-eabi-objdump disassembling axoloti.elf rather than the binary code?<br>I also suggest to ask on gcc-arm-embedded related discussion lists.</p>

<aside class="quote" data-post="17" data-topic="811"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/rekado/40/1059_1.html" class="avatar">rekado:</div>
<blockquote><p>Uploading my firmware in DFU mode causes the board to "die"; lsusb doesn't show that it's connected.  Why doesn't this happen when I upload it via the GUI in normal mode?</p></blockquote></aside>

<p>Uploading the standard firmware or your firmware? Double check the paths involved. How the firmware image is flashed does not matter. If the firmware does not run properly (due to the differences), and does not reach the firmware usb device setup, there will be nothing visible in lsusb.</p>

<p>Anyway thumbs up for getting it running!</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:2'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/rekado.html'><b itemprop='author'>rekado</b></a>
           
           <time datetime='2016-01-05T07:41:53Z' itemprop='datePublished'>
             2016-01-05 07:41:53 UTC
           </time>
        </span>
        <span itemprop='position'>#20</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote" data-post="19" data-topic="811"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/johannes/40/8_1.png" class="avatar">johannes:</div>
<blockquote><p>Uploading the standard firmware or your firmware?</p></blockquote></aside>

<p>Uploading my own firmware.  If I do this in the GUI via normal mode (i.e. the LED is lit) dfu-util starts working, but at the end when it says that the firmware was uploaded successfully the board reboots and the firmware hasn't actually been changed. (It reports a CRC mismatch again and again, and when downloading the firmware from the board I see that it's still the same binary as before.)</p>

<p>Only when flashing in DFU mode the firmware is in fact changed (as shown by downloading the uploaded firmware and comparing it) --- and since my firmware seems to be broken the board never initialises USB, so lsusb doesn't show it.</p>

<p>I find it odd that in normal mode this error does not occur and everything suggests that the firmware was updated, when in fact it was not.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Building from source for GNU Guix (was: Stuck in DFU mode)'>
      <hr>
  </div>

  <div role='navigation' itemscope itemtype='http://schema.org/SiteNavigationElement'>
      <span itemprop='url'><b><a rel="next" itemprop="name" href="8114658.html?page=2">next page →</a></b></span>
  </div>





    </div>
    <footer class="container">
      <nav itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <a href='../../index.html'>Home</a>
        <a href="../../categories.html">Categories</a>
        <a href="../../guidelines.html">FAQ/Guidelines</a>
        <a href="../../tos.html">Terms of Service</a>
        <a href="../../privacy.html">Privacy Policy</a>
      </nav>
      <p>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
    
  </body>
  

<!-- Mirrored from community.axoloti.com/t/building-from-source-for-gnu-guix-was-stuck-in-dfu-mode/811 by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 19 Jul 2023 03:59:15 GMT -->
</html>
