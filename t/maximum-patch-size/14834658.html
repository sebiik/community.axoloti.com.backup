<!DOCTYPE html>
<html lang="en">
  
<!-- Mirrored from community.axoloti.com/t/maximum-patch-size/1483?page=2 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 10 Jul 2023 16:05:49 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Maximum patch size? - Developer - Axoloti Community</title>
    <meta name="description" content="What is the maximum size for the binary image for a patch? I&amp;#39;m having a problem where I have a patch where the resulting binary is 7484 bytes in size which runs fine, but when I add some code and the size increases to 76&amp;hellip;">
    <meta name="author" content="">
<meta name="generator" content="Discourse 1.9.0.beta3 - https://github.com/discourse/discourse version 13f3de4bf673802eb8ec595d36587b4524773209">
<link rel="icon" type="image/png" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<link rel="icon" sizes="144x144" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<link rel="canonical" href="14834658.html?page=2" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"http://community.axoloti.com","potentialAction":{"@type":"SearchAction","target":"http://community.axoloti.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="Axoloti Community Search">

        <link href="../../stylesheets/desktop_d93a33ca8617326fe353f80e6ab865188244d48c8e0b.css?__ws=community.axoloti.com" media="all" rel="stylesheet" data-target="desktop"/>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','../../../www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56017691-4', {"cookieDomain":"auto"});
</script>

      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Maximum patch size?&#39;" href="1483.rss" />
  <meta property="og:site_name" content="Axoloti Community" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="http://community.axoloti.com/uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png" />
<meta property="og:image" content="http://community.axoloti.com/uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png" />
<meta property="og:url" content="http://community.axoloti.com/t/maximum-patch-size/1483?page=2" />
<meta name="twitter:url" content="http://community.axoloti.com/t/maximum-patch-size/1483?page=2" />
<meta property="og:title" content="Maximum patch size?" />
<meta name="twitter:title" content="Maximum patch size?" />
<meta property="og:description" content="i agree, it is a bit surprising that this has not been hit more. However, it seems that what&#39;s in this section in practice is a pointer to a list of function pointers, which thus corresponds to at most two instructions.   Another way of looking at it is that if the problem had caused more problems, it would have been fixed earlier as it would have been more obvious that something waas wrong. By sheer luck, the instructions resulting from the pointers have in most cases been harmless, if that h..." />
<meta name="twitter:description" content="i agree, it is a bit surprising that this has not been hit more. However, it seems that what&#39;s in this section in practice is a pointer to a list of function pointers, which thus corresponds to at most two instructions.   Another way of looking at it is that if the problem had caused more problems, it would have been fixed earlier as it would have been more obvious that something waas wrong. By sheer luck, the instructions resulting from the pointers have in most cases been harmless, if that h..." />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="14 mins üïë" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="3 ‚ù§" />

      <link rel="prev" href="1483.html">

  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html"><img src="../../uploads/default/original/1X/b22e6e9ef608f1e17a1de19b733d043beff77f05.png" alt="Axoloti Community" id="site-logo" style="max-width: 150px;"></a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1>
  <a href="1483.html">Maximum patch size?</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/developer.html" itemprop="url">
        <span itemprop="title">Developer</span>
      </a>
    </div>
</div>





<hr>


  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/ricard.html'><b itemprop='author'>ricard</b></a>
           
           <time datetime='2016-04-16T17:52:01Z' itemprop='datePublished'>
             2016-04-16 17:52:01 UTC
           </time>
        </span>
        <span itemprop='position'>#21</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote" data-post="20" data-topic="1483" data-full="true"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/thetechnobear/40/6_1.html" class="avatar">thetechnobear:</div>
<blockquote>
<p>just had a look, yeah I think you are on to something.... as you say PATCHMAINLOC seems to expect the code is the first thing in SRAM.   <a class="mention" href="../../users/johannes.html">@johannes</a> thoughts?</p>
<p>but, if this is the case, Im quite surprised, we are not seeing more failures... as there must be quite a few static constructors... and it appears if any of these create some kind of call op, then bang...</p>
</blockquote></aside>

<p>i agree, it is a bit surprising that this has not been hit more. However, it seems that what's in this section in practice is a pointer to a list of function pointers, which thus corresponds to at most two instructions.</p>

<p>Another way of looking at it is that if the problem had caused more problems, it would have been fixed earlier as it would have been more obvious that something waas wrong. By sheer luck, the instructions resulting from the pointers have in most cases been harmless, if that hadn't been the case, the system would have crashed and misbehaved so often that someone would have needed to have a lok at it a long time ago.</p>

<p><aside class="quote"><blockquote><p>I can't see any harm in moving the ctor/dtor and will give it a go, but it would be nice to prove this is the case, somehow with a 'destructive test'....</p></blockquote></aside></p>

<p>To me, it's quite obvious that the constructor/destructor arrays should not be called as code ... and it wasn't always that way, those sections were introduced in commit <br>203580f5... on 2015-08-04, thus it wasn't part of the original design. The constructor list is explicitly traversed in xpatch_init2(), so there's no way it can be meant to be executed directly.</p>

<p>It all ties in with the symptoms too: the dependence on the patch size, especially that it is not a linear correspondance, i.e. patches don't necessarily break over a certain size, the relative independence of the firmware code, the fact that the constructor code in my case equates to setting r4 to 1 which is the behavior I've observed, not to mention the disassembly of the code actually executed when calling PATCHMAINLOC.</p>

<p>Anyhow, I tested my 'problem patch' with the constructor and destructor sections moved to after the text section in xpatch.bin, and it works fine now, in all configurations of it (I have been testing by remove one, two or three calls to my printpar() local function, with the the constructors list at the start of xpatch.bin, removing all three has always worked, and depending on the rest of the code removing one or two has sometimes worked, wheras leaving all three there has never worked.)</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:1'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Maximum patch size?'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/thetechnobear.html'><b itemprop='author'>thetechnobear</b></a>
           
           <time datetime='2016-04-16T21:08:18Z' itemprop='datePublished'>
             2016-04-16 21:08:18 UTC
           </time>
        </span>
        <span itemprop='position'>#22</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote" data-post="21" data-topic="1483"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/ricard/40/163_1.html" class="avatar">ricard:</div>
<blockquote><p>203580f5... on 2015-08-04, thus it wasn't part of the original design. The constructor list is explicitly traversed in xpatch_init2(), so there's no way it can be meant to be executed directly.</p></blockquote></aside>

<p>oops, my bad <img src="../../images/emoji/emoji_one/frowninga4f0.png?v=0" title=":frowning:" class="emoji" alt=":frowning:"> </p>

<p>was quite some time back... I did it to fix issue with static dtor/ctor not being called... which worked,<br>and I placed it in the same 'relative' place as is done in the STM32.ld file... <br>but it didn't occur to me that of course, the patch start point is consider to be at the beginning...</p>

<p>I'll move it now... </p>

<p>BUT... <br>I suspect the correct implementation is to change .text to ...</p>

<pre><code>.text : ALIGN(16) SUBALIGN(16)
{
    PROVIDE(__code_start = .);
    * (.boot);
    * (.text);
    etext = .;
} &gt; SRAM</code></pre>

<p>such that the start of the code, is not hardcoded but derived from the ld file... <br>(so if it moves , changes, then this will move with it)</p>

<p>thoughts?</p>

<p>EDIT: forgot to say <strong>very cool bit of debugging... thanks for putting the effort into this</strong>  <img src="../../images/emoji/emoji_one/booma4f0.png?v=0" title=":boom:" class="emoji" alt=":boom:"></p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Maximum patch size?'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/ricard.html'><b itemprop='author'>ricard</b></a>
           
           <time datetime='2016-04-16T21:31:06Z' itemprop='datePublished'>
             2016-04-16 21:31:06 UTC
           </time>
        </span>
        <span itemprop='position'>#23</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote" data-post="22" data-topic="1483" data-full="true"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/thetechnobear/40/6_1.html" class="avatar">thetechnobear:</div>
<blockquote>
<p>I suspect the correct implementation is to change .text to ...<br>[ ... ]<br>such that the start of the code, is not hardcoded but derived from the ld file... <br>(so if it moves , changes, then this will move with it)</p>
<p>thoughts?</p>
</blockquote></aside>

<p>I'm assuming you mean in addition to moving the constructors/destructors segment? Otherwise there will still be an offset from the start of the binary to the xpatch_init() function.</p>

<p>I must say I'm not sure what <code>PROVIDE(__code_start = .);</code> actually does. Does it guarantee that the start of the code is at the start of the .text segment? Or is there some form of attribute one can give to a specific function so that the linker puts it at the address specified by <code>__code_start</code>?</p>

<p>Actually, looking at xpatch.cpp, this is actually done already: the code for xpatch_init() is as follows (from xpatch.cpp):</p>

<pre><code>extern "C" __attribute__ ((section(".boot"))) void xpatch_init(int fwid){
  xpatch_init2(fwid);
}</code></pre>

<p>and the <code>__attribute__((section(".boot"))</code> puts it in the .boot section which is before the .text section in the .text segment. But maybe I'm misunderstaning you as I don't really know what PROVIDES really does.</p>

<p><aside class="quote"><blockquote><p>EDIT: forgot to say <strong>very cool bit of debugging... thanks for putting the effort into this</strong>  <img src="../../images/emoji/emoji_one/booma4f0.png?v=0" title=":boom:" class="emoji" alt=":boom:"></p></blockquote></aside></p>

<p>Thanks. I just couldn't walk away from this (and I figured if I couldn't fix it I wouldn't be able to get any further with the patch I was working on...).</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Maximum patch size?'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/thetechnobear.html'><b itemprop='author'>thetechnobear</b></a>
           
           <time datetime='2016-04-16T22:26:21Z' itemprop='datePublished'>
             2016-04-16 22:26:21 UTC
           </time>
        </span>
        <span itemprop='position'>#24</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>provide gives you a variable initialised to the actually position allocated by the linker.</p>

<p>yes, i meant in addition.</p>

<p>but I realised, it doesn't actually help... as the pointer is needed in patch.c, not in xpatch.<br>I guess something could be defined in STM32F407.ld, but it doesnt really help, as its just having to trust that the binary sent, really does have the code at the beginning.<br>(the section code, you show above forces this, assuming .boot is at the start)</p>

<p>still amazed, we haven't seen more issues... guess the wind has been blowing in the right direction.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='Maximum patch size?'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/ricard.html'><b itemprop='author'>ricard</b></a>
           
           <time datetime='2016-04-16T22:55:27Z' itemprop='datePublished'>
             2016-04-16 22:55:27 UTC
           </time>
        </span>
        <span itemprop='position'>#25</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote" data-post="24" data-topic="1483" data-full="true"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/thetechnobear/40/6_1.html" class="avatar">thetechnobear:</div>
<blockquote><p>provide gives you a variable initialised to the actually position allocated by the linker.</p></blockquote></aside>

<p>Ah. That simple. I should have guessed...</p>

<p><aside class="quote"><blockquote><p>but I realised, it doesn't actually help... as the pointer is needed in patch.c, not in xpatch.<br>I guess something could be defined in STM32F407.ld, but it doesnt really help, as its just having to trust that the binary sent, really does have the code at the beginning.<br>(the section code, you show above forces this, assuming .boot is at the start)</p></blockquote></aside></p>

<p>In ramlink.ld, .boot is before .text, so yes. Perhaps there should be a comment there that it really needs to be first so no one misses it in the fuure.</p>

<p><aside class="quote"><blockquote><p>still amazed, we haven't seen more issues... guess the wind has been blowing in the right direction.</p></blockquote></aside></p>

<p>The funny thing is that I have had various issues, i.e. things misbehaving, but I always assumed I'd done something wrong in the patch so I changed someting and voila, it would work again. So probably there have been a few hickups which people have passed off as other errors.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='Maximum patch size?'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/ricard.html'><b itemprop='author'>ricard</b></a>
           
           <time datetime='2016-04-17T17:23:09Z' itemprop='datePublished'>
             2016-04-17 17:23:09 UTC
           </time>
        </span>
        <span itemprop='position'>#26</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>A quick note to anyone reading this thread: as noted in another thread</p>

<aside class="quote" data-post="1" data-topic="1513">
  <div class="title">
    <div class="quote-controls"></div>
    <img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/ricard/40/163_1.html" class="avatar">
    <a href="../patches-fail-to-init-due-to-malplaced-data-at-start-of-patch-binary/1513.html">Patches fail to init due to malplaced data at start of patch binary</a> <a class="badge-wrapper  bullet" href="../../c/helpdesk.html"><span class="badge-category-bg" style="background-color: #9EB83B;"></span><span style="color: #FFFFFF;" data-drop-close="true" class="badge-category clear-badge" title='This category is for reporting issues and bugsPlease use other categories for discussions on features or questions or "how to?"'>Helpdesk</span></a>
  </div>
  <blockquote>This thread: <a href="1483/12.html">http://community.axoloti.com/t/maximum-patch-size/1483/12</a> started out as a question about the maximum size of a patch, but in the end I determined that there is bug in ramlink.ld, which puts a couple of arrays before the patch init function. The net result is that when the firmware calls PATCHMAINLOC to initialize the patch, the data in the arrays (pointers) are interpreted as code, which is then run before the actual init function, which can potentially wreck havoc with patch initi‚Ä¶
    <div class="topic-info">
    </div>
  </blockquote>
</aside>


<p>a fix for this has now been merged to the Axoloti firmware master  branch.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:1'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='Maximum patch size?'>
      <hr>
  </div>

  <div role='navigation' itemscope itemtype='http://schema.org/SiteNavigationElement'>
      <span itemprop='url'><a rel="prev" itemprop="name" href="1483.html">‚Üê previous page</a></span>
  </div>





    </div>
    <footer class="container">
      <nav itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <a href='../../index.html'>Home</a>
        <a href="../../categories.html">Categories</a>
        <a href="../../guidelines.html">FAQ/Guidelines</a>
        <a href="../../tos.html">Terms of Service</a>
        <a href="../../privacy.html">Privacy Policy</a>
      </nav>
      <p>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
    
  </body>
  

<!-- Mirrored from community.axoloti.com/t/maximum-patch-size/1483?page=2 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 10 Jul 2023 16:05:49 GMT -->
</html>
