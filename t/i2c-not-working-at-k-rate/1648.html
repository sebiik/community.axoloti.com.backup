<!DOCTYPE html>
<html lang="en">
  
<!-- Mirrored from community.axoloti.com/t/i2c-not-working-at-k-rate/1648 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 10 Jul 2023 17:03:06 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>i2c not working at K-rate - AxoObject coding - Axoloti Community</title>
    <meta name="description" content="We want to communicate with a g sensor via i2c. The following code in the init tab returns signals successfully from the sensor: 

// setup the pins
palSetPadMode(GPIOB, 8, PAL_MODE_ALTERNATE(4)|PAL_STM32_PUDR_PULLUP|PAL&amp;hellip;">
    <meta name="author" content="">
<meta name="generator" content="Discourse 1.9.0.beta3 - https://github.com/discourse/discourse version 13f3de4bf673802eb8ec595d36587b4524773209">
<link rel="icon" type="image/png" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<link rel="icon" sizes="144x144" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<link rel="canonical" href="1648.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"http://community.axoloti.com","potentialAction":{"@type":"SearchAction","target":"http://community.axoloti.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="Axoloti Community Search">

        <link href="../../stylesheets/desktop_d93a33ca8617326fe353f80e6ab865188244d48c8e0b.css?__ws=community.axoloti.com" media="all" rel="stylesheet" data-target="desktop"/>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','../../../www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56017691-4', {"cookieDomain":"auto"});
</script>

      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;i2c not working at K-rate&#39;" href="1648.rss" />
  <meta property="og:site_name" content="Axoloti Community" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="http://community.axoloti.com/uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png" />
<meta property="og:image" content="http://community.axoloti.com/uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png" />
<meta property="og:url" content="http://community.axoloti.com/t/i2c-not-working-at-k-rate/1648" />
<meta name="twitter:url" content="http://community.axoloti.com/t/i2c-not-working-at-k-rate/1648" />
<meta property="og:title" content="i2c not working at K-rate" />
<meta name="twitter:title" content="i2c not working at K-rate" />
<meta property="og:description" content="We want to communicate with a g sensor via i2c. The following code in the init tab returns signals successfully from the sensor:   // setup the pins palSetPadMode(GPIOB, 8, PAL_MODE_ALTERNATE(4)|PAL_STM32_PUDR_PULLUP|PAL_STM32_OTYPE_OPENDRAIN);// SCL palSetPadMode(GPIOB, 9, PAL_MODE_ALTERNATE(4)|PAL_STM32_PUDR_PULLUP|PAL_STM32_OTYPE_OPENDRAIN);// SDA const int MPU_addr=0x68; static const I2CConfig i2cfg = {     OPMODE_I2C,     400000,     FAST_DUTY_CYCLE_2, }; i2cStart(&amp;I2CD1, &amp;i2cfg); uint8_t t..." />
<meta name="twitter:description" content="We want to communicate with a g sensor via i2c. The following code in the init tab returns signals successfully from the sensor:   // setup the pins palSetPadMode(GPIOB, 8, PAL_MODE_ALTERNATE(4)|PAL_STM32_PUDR_PULLUP|PAL_STM32_OTYPE_OPENDRAIN);// SCL palSetPadMode(GPIOB, 9, PAL_MODE_ALTERNATE(4)|PAL_STM32_PUDR_PULLUP|PAL_STM32_OTYPE_OPENDRAIN);// SDA const int MPU_addr=0x68; static const I2CConfig i2cfg = {     OPMODE_I2C,     400000,     FAST_DUTY_CYCLE_2, }; i2cStart(&amp;I2CD1, &amp;i2cfg); uint8_t t..." />


  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html"><img src="../../uploads/default/original/1X/b22e6e9ef608f1e17a1de19b733d043beff77f05.png" alt="Axoloti Community" id="site-logo" style="max-width: 150px;"></a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1>
  <a href="1648.html">i2c not working at K-rate</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/axoobject-code.html" itemprop="url">
        <span itemprop="title">AxoObject coding</span>
      </a>
    </div>
</div>





<hr>


  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/Hugo.html'><b itemprop='author'>Hugo</b></a>
           
           <time datetime='2016-05-06T20:46:25Z' itemprop='datePublished'>
             2016-05-06 20:46:25 UTC
           </time>
        </span>
        <span itemprop='position'>#1</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>We want to communicate with a g sensor via i2c. The following code in the init tab returns signals successfully from the sensor:</p>

<pre><code>// setup the pins
palSetPadMode(GPIOB, 8, PAL_MODE_ALTERNATE(4)|PAL_STM32_PUDR_PULLUP|PAL_STM32_OTYPE_OPENDRAIN);// SCL
palSetPadMode(GPIOB, 9, PAL_MODE_ALTERNATE(4)|PAL_STM32_PUDR_PULLUP|PAL_STM32_OTYPE_OPENDRAIN);// SDA
const int MPU_addr=0x68;
static const I2CConfig i2cfg = {
    OPMODE_I2C,
    400000,
    FAST_DUTY_CYCLE_2,
};
i2cStart(&amp;I2CD1, &amp;i2cfg);
uint8_t transmitBuffer = 0x6B;
uint8_t receiveBuffer[14];
i2cMasterTransmitTimeout(&amp;I2CD1, MPU_addr, &amp;transmitBuffer, 4, receiveBuffer, 0, 30);
transmitBuffer = 0x0;
i2cMasterTransmitTimeout(&amp;I2CD1, MPU_addr, &amp;transmitBuffer, 1, receiveBuffer, 0, 30);

transmitBuffer = 0x3B;
i2cMasterTransmitTimeout(&amp;I2CD1, MPU_addr, &amp;transmitBuffer, 1, receiveBuffer, 14, 30);
LogTextMessage("%d", receiveBuffer[1]);</code></pre>

<p>We are using this code in the K-Rate tab:</p>

<pre><code>  if(++i == 1000) {
	i = 0;
	const int MPU_addr=0x68;
	uint8_t transmitBuffer;
	uint8_t receiveBuffer[14];
	transmitBuffer = 0x3B;
	msg_t status = i2cMasterTransmitTimeout(&amp;I2CD1, MPU_addr, &amp;transmitBuffer, 1, receiveBuffer, 14, 30);
	LogTextMessage("status: %d", status);
	if(status == RDY_RESET) {
		i2cflags_t error = i2cGetErrors(&amp;I2CD1);
		LogTextMessage("error: %d", error);
	} else if(status == RDY_TIMEOUT) {
		LogTextMessage("timeout");
	}
	LogTextMessage("%d", receiveBuffer[1]);
}</code></pre>

<p>At K-rate an external i2c scope shows that continuously one wrong byte is transmitted from the axoloti board to the sensor and the receiveBuffer always contains the same values as in the init step.<br>The status message returned by i2cMasterTransmitTimeout() is RDY_OK.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='i2c not working at K-rate'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/johannes.html'><b itemprop='author'>johannes</b></a>
           
           <time datetime='2016-05-07T14:40:56Z' itemprop='datePublished'>
             2016-05-07 14:40:56 UTC
           </time>
        </span>
        <span itemprop='position'>#2</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Best practice is keeping k-rate code free of functions that take considerable time to process.<br>This can be done by creating a thread at initialization and waking up that thread periodically, you could sleep the thread for a certain time, or wake up the thread from k-rate by sending it a signal.<br>The script/script2 object internals shows how create (and cleanup) a thread.</p>

<p>Another important thing is that the data for I2C transactions must be located in a DMA-capable memory area.<br>like</p>

<pre><code>    // allocate buffers suitable for DMA transfert!
    static uint8_t _txbuf[8] __attribute__ ((section (".sram2")));
    static uint8_t _rxbuf[8] __attribute__ ((section (".sram2")));</code></pre>

<p>I suggest to take a look at axoloti/archive/tests/io/spi_lkm1638.axh for an example that uses SPI and script2.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='i2c not working at K-rate'>
      <hr>
  </div>






    </div>
    <footer class="container">
      <nav itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <a href='../../index.html'>Home</a>
        <a href="../../categories.html">Categories</a>
        <a href="../../guidelines.html">FAQ/Guidelines</a>
        <a href="../../tos.html">Terms of Service</a>
        <a href="../../privacy.html">Privacy Policy</a>
      </nav>
      <p>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
    
  </body>
  

<!-- Mirrored from community.axoloti.com/t/i2c-not-working-at-k-rate/1648 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 10 Jul 2023 17:03:07 GMT -->
</html>
