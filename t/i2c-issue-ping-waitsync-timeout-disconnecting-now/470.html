<!DOCTYPE html>
<html lang="en">
  
<!-- Mirrored from community.axoloti.com/t/i2c-issue-ping-waitsync-timeout-disconnecting-now/470 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 10 Jul 2023 17:08:30 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>I2C Issue(?): Ping: WaitSync Timeout, disconnecting now - Software - Axoloti Community</title>
    <meta name="description" content="Hi, 

I&amp;#39;m trying to connect my axoloti to an Arduino Uno. I&amp;#39;m using the chibios i2c library for it and I&amp;#39;m embedding the code into a script2 object (btw. is it possible to do this in a *.axo object without having to care&amp;hellip;">
    <meta name="author" content="">
<meta name="generator" content="Discourse 1.9.0.beta3 - https://github.com/discourse/discourse version 13f3de4bf673802eb8ec595d36587b4524773209">
<link rel="icon" type="image/png" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<link rel="icon" sizes="144x144" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<link rel="canonical" href="470.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://sebiik.github.io/community.axoloti.com.backup","potentialAction":{"@type":"SearchAction","target":"https://sebiik.github.io/community.axoloti.com.backup/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="Axoloti Community Search">

        <link href="../../stylesheets/desktop_d93a33ca8617326fe353f80e6ab865188244d48c8e0b.css?__ws=community.axoloti.com" media="all" rel="stylesheet" data-target="desktop"/>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','../../../www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56017691-4', {"cookieDomain":"auto"});
</script>

      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;I2C Issue(?): Ping: WaitSync Timeout, disconnecting now&#39;" href="470.rss" />
  <meta property="og:site_name" content="Axoloti Community" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://sebiik.github.io/community.axoloti.com.backup/uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png" />
<meta property="og:image" content="https://sebiik.github.io/community.axoloti.com.backup/uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png" />
<meta property="og:url" content="https://sebiik.github.io/community.axoloti.com.backup/t/i2c-issue-ping-waitsync-timeout-disconnecting-now/470" />
<meta name="twitter:url" content="https://sebiik.github.io/community.axoloti.com.backup/t/i2c-issue-ping-waitsync-timeout-disconnecting-now/470" />
<meta property="og:title" content="I2C Issue(?): Ping: WaitSync Timeout, disconnecting now" />
<meta name="twitter:title" content="I2C Issue(?): Ping: WaitSync Timeout, disconnecting now" />
<meta property="og:description" content="Hi,   I&#39;m trying to connect my axoloti to an Arduino Uno. I&#39;m using the chibios i2c library for it and I&#39;m embedding the code into a script2 object (btw. is it possible to do this in a *.axo object without having to care about threading?).   Problem is, my axoloti stops as soon as I fire the first i2c commands to the Arduino (and when they are received, without a connection everything goes fine).  This is the error I get, afterwards I have to unplug the USB cable in order to be able to reconnect..." />
<meta name="twitter:description" content="Hi,   I&#39;m trying to connect my axoloti to an Arduino Uno. I&#39;m using the chibios i2c library for it and I&#39;m embedding the code into a script2 object (btw. is it possible to do this in a *.axo object without having to care about threading?).   Problem is, my axoloti stops as soon as I fire the first i2c commands to the Arduino (and when they are received, without a connection everything goes fine).  This is the error I get, afterwards I have to unplug the USB cable in order to be able to reconnect..." />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="1 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="2 ❤" />


  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html"><img src="../../uploads/default/original/1X/b22e6e9ef608f1e17a1de19b733d043beff77f05.png" alt="Axoloti Community" id="site-logo" style="max-width: 150px;"></a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1>
  <a href="470.html">I2C Issue(?): Ping: WaitSync Timeout, disconnecting now</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/software.html" itemprop="url">
        <span itemprop="title">Software</span>
      </a>
    </div>
</div>





<hr>


  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/moja.html'><b itemprop='author'>moja</b></a>
           
           <time datetime='2015-09-17T21:11:00Z' itemprop='datePublished'>
             2015-09-17 21:11:00 UTC
           </time>
        </span>
        <span itemprop='position'>#1</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Hi,</p>

<p>I'm trying to connect my axoloti to an Arduino Uno. I'm using the chibios i2c library for it and I'm embedding the code into a script2 object (btw. is it possible to do this in a *.axo object without having to care about threading?).</p>

<p>Problem is, my axoloti stops as soon as I fire the first i2c commands to the Arduino (and when they are received, without a connection everything goes fine). <br>This is the error I get, afterwards I have to unplug the USB cable in order to be able to reconnect again:</p>

<pre><code>Done uploading patch
Start starting patch
Done starting patch
Start locking
Done locking
Ping: WaitSync Timeout, disconnecting now
Disconnect request
Control transfer failed: -7</code></pre>

<p>The script I'm using looks like this (I don't have anything else, except disp/i objects in my patcher).</p>

<pre><code>#include &lt;hal.h&gt;

struct data_pkg_t {
    uint8_t channel;
    uint8_t value;
};

void setup() {
    palSetPadMode(GPIOB, 8, PAL_MODE_ALTERNATE(4)|PAL_STM32_PUDR_PULLUP|PAL_STM32_OTYPE_OPENDRAIN);// SCL
    palSetPadMode(GPIOB, 9, PAL_MODE_ALTERNATE(4)|PAL_STM32_PUDR_PULLUP|PAL_STM32_OTYPE_OPENDRAIN);// SDA
    static const I2CConfig i2cfg = {
        OPMODE_I2C,
        100000,
        STD_DUTY_CYCLE,
    };
    i2cStart(&amp;I2CD1, &amp;i2cfg);
    out2 = _INT(10);
}


void loop() {
    chThdSleepSeconds(1);
    
    struct data_pkg_t channelValue;
    msg_t msg = i2cMasterReceive(&amp;I2CD1, 8,(uint8_t *) &amp;channelValue, sizeof(channelValue));
    if (msg != RDY_OK) {
        out2 = _INT(i2cGetErrors(&amp;I2CD1));
        return;
    }
    
    out1 = _INT(channelValue.channel);
    out2 = _INT(channelValue.value);
}</code></pre>

<p>I already tried wrapping my call i2cAcquireBus() and i2cReleaseBus() with no luck. The problem even occurs when in the following cases:</p>

<ul>
<li>Using i2cMasterReceiveTimeout</li>
<li>Not calling any i2cMasterReceive method, but just acquire and release</li>
<li>Using simple types instead of the struct</li>
</ul>

<p>The arduino code is basically <a href="https://www.arduino.cc/en/Tutorial/MasterReader" rel="nofollow">https://www.arduino.cc/en/Tutorial/MasterReader</a> (Code for Slave Sender - Program for Arduino 2)</p>

<p>Any hints? I don't really know how to debug this further, the next step will be starting gdb... I could switch to UART, but I would really want to know, what the problem is here.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='I2C Issue(?): Ping: WaitSync Timeout, disconnecting now'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/johannes.html'><b itemprop='author'>johannes</b></a>
           
           <time datetime='2015-09-17T22:08:46Z' itemprop='datePublished'>
             2015-09-17 22:08:46 UTC
           </time>
        </span>
        <span itemprop='position'>#2</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>The buffers you use for I2C send and receive must be declared in a different section of memory. That is required for DMA. Check archive/tests/io/spi_lkm1638.axh for an example.</p>

<pre><code>static uint8_t _txbuf[8] __attribute__ ((section (".sram2")));
static uint8_t _rxbuf[8] __attribute__ ((section (".sram2")));</code></pre>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='I2C Issue(?): Ping: WaitSync Timeout, disconnecting now'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/moja.html'><b itemprop='author'>moja</b></a>
           
           <time datetime='2015-09-18T07:22:32Z' itemprop='datePublished'>
             2015-09-18 07:22:32 UTC
           </time>
        </span>
        <span itemprop='position'>#3</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Thanks for the quick reply, that totally makes sense... I'll give feedback when I got it running.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='I2C Issue(?): Ping: WaitSync Timeout, disconnecting now'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/moja.html'><b itemprop='author'>moja</b></a>
           
           <time datetime='2015-09-18T10:45:01Z' itemprop='datePublished'>
             2015-09-18 10:45:01 UTC
           </time>
        </span>
        <span itemprop='position'>#4</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Brilliant, this did the trick. One more thing occured: When I restarted the patch, the WaitSync Timeout occured again. I figured out that this is a conflict because of the i2c Driver not being freed correctly. Adding </p>

<pre><code>if (chThdShouldTerminate()) {
       i2cStop(&amp;I2CD1);
       return;
 }</code></pre>

<p>Prevented this from happening.  The basic code now looks like this.</p>

<pre><code>#include &lt;hal.h&gt;

// helper for converting frac32 to int
__attribute__ ( ( always_inline ) ) __STATIC_INLINE int32_t _INT(float op1) {
    return op1 * (0xffffffff &gt;&gt; 1) / 1024;
}

struct data_pkg_t {
    uint8_t channel;
    uint8_t value;
}; 

struct data_pkg_t *rxBuffer; // Pointer to the rx Buffer

void setup() {
    static struct data_pkg_t _rxBuffer __attribute__ ((section (".sram2")));
    rxBuffer = &amp;_rxBuffer;

    palSetPadMode(GPIOB, 8, PAL_MODE_ALTERNATE(4)|PAL_STM32_PUDR_PULLUP|PAL_STM32_OTYPE_OPENDRAIN);// SCL
    palSetPadMode(GPIOB, 9, PAL_MODE_ALTERNATE(4)|PAL_STM32_PUDR_PULLUP|PAL_STM32_OTYPE_OPENDRAIN);// SDA
    static const I2CConfig i2cfg = {
        OPMODE_I2C,
        100000,			// 100000 is the value of the Arduino Wire library
        FAST_DUTY_CYCLE_2,	
    };
    i2cStart(&amp;I2CD1, &amp;i2cfg);
}

void loop() {
    chThdSleepMilliseconds(20);
    
    if (chThdShouldTerminate()) {
        i2cStop(&amp;I2CD1);
        return;
    }

    // receive the current value
    msg_t msg = i2cMasterReceive(&amp;I2CD1, 8,(uint8_t *) rxBuffer, sizeof(data_pkg_t));

    if (msg != RDY_OK) {
	out1 = _INT(-1);
	out2 = _INT(i2cGetErrors(&amp;I2CD1));
        return;
    }
    
    out1 = _INT(rxBuffer-&gt;channel);
    out2 = _INT(rxBuffer-&gt;value);
}</code></pre>

<p>The Arduino code is:</p>

<pre><code>#include &lt;Wire.h&gt;

struct data_pkg_t {
  uint8_t channel;
  uint8_t value;
};

void setup()
{
  
  Wire.begin(8);                // join i2c bus with address #8
  Wire.onRequest(requestEvent); // register event
  Serial.begin(57600);
  Serial.write("setup done \n");
}

void loop()
{
  delay(100);
}

// function that executes whenever data is requested by master
// this function is registered as an event, see setup()
void requestEvent() {
  struct data_pkg_t data = {4, 127};
  Serial.write("Sending \n");
  Wire.write((uint8_t*) &amp;data, sizeof(data)); // respond with message
  Serial.write("Sent \n");  
}</code></pre>

<p>The setup is rather simple, Axoloti PB9 is connected to the Arduino UNO A4, Axoloti PB8 to A3. </p>

<p><div class="lightbox-wrapper"><a data-download-href="//community.axoloti.com/uploads/default/304db6a938ec1becd12edaa66a17d6e73b8f918d" href="../../uploads/default/original/1X/304db6a938ec1becd12edaa66a17d6e73b8f918d.png" class="lightbox" title="Screen Shot 2015-09-18 at 12.40.58.png"><img src="../../uploads/default/optimized/1X/304db6a938ec1becd12edaa66a17d6e73b8f918d_1_690x480.png" width="690" height="480"><div class="meta">
<span class="filename">Screen Shot 2015-09-18 at 12.40.58.png</span><span class="informations">732x510 31.6 KB</span><span class="expand"></span>
</div></a></div></p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:2'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='I2C Issue(?): Ping: WaitSync Timeout, disconnecting now'>
      <hr>
  </div>






    </div>
    <footer class="container">
      <nav itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <a href='../../index.html'>Home</a>
        <a href="../../categories.html">Categories</a>
        <a href="../../guidelines.html">FAQ/Guidelines</a>
        <a href="../../tos.html">Terms of Service</a>
        <a href="../../privacy.html">Privacy Policy</a>
      </nav>
      <p>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
    
  </body>
  

<!-- Mirrored from community.axoloti.com/t/i2c-issue-ping-waitsync-timeout-disconnecting-now/470 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 10 Jul 2023 17:08:34 GMT -->
</html>
