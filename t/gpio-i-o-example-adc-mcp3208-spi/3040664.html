<!DOCTYPE html>
<html lang="en">
  
<!-- Mirrored from community.axoloti.com/t/gpio-i-o-example-adc-mcp3208-spi/304?source_topic_id=3962 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 10 Jul 2023 17:17:22 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>[GPIO I/O] Example ADC MCP3208 &amp; SPI - Patching - Axoloti Community</title>
    <meta name="description" content="Hi everyone, this example should show, how a MCP3208 can be used to read eight analog sources. The MCP3208 is connected to axoloti SPI port. This ADC method is much faster then the 4051 method and the MCP3208 has an inpu&amp;hellip;">
    <meta name="author" content="">
<meta name="generator" content="Discourse 1.9.0.beta3 - https://github.com/discourse/discourse version 13f3de4bf673802eb8ec595d36587b4524773209">
<link rel="icon" type="image/png" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<link rel="icon" sizes="144x144" href="../../uploads/default/original/1X/ffed196003990f0e5c2a0f8227fc977345cd68be.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<link rel="canonical" href="304.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"http://community.axoloti.com","potentialAction":{"@type":"SearchAction","target":"http://community.axoloti.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="Axoloti Community Search">

        <link href="../../stylesheets/desktop_d93a33ca8617326fe353f80e6ab865188244d48c8e0b.css?__ws=community.axoloti.com" media="all" rel="stylesheet" data-target="desktop"/>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','../../../www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56017691-4', {"cookieDomain":"auto"});
</script>

      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;[GPIO I/O] Example ADC MCP3208 &amp; SPI&#39;" href="304.rss" />
  <meta property="og:site_name" content="Axoloti Community" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="http://community.axoloti.com/uploads/default/original/1X/d7dc02701aa8cc8e7ce431a9e2476345c377de1b.png" />
<meta property="og:image" content="http://community.axoloti.com/uploads/default/original/1X/d7dc02701aa8cc8e7ce431a9e2476345c377de1b.png" />
<meta property="og:url" content="http://community.axoloti.com/t/gpio-i-o-example-adc-mcp3208-spi/304?source_topic_id=3962" />
<meta name="twitter:url" content="http://community.axoloti.com/t/gpio-i-o-example-adc-mcp3208-spi/304?source_topic_id=3962" />
<meta property="og:title" content="[GPIO I/O] Example ADC MCP3208 &amp; SPI" />
<meta name="twitter:title" content="[GPIO I/O] Example ADC MCP3208 &amp; SPI" />
<meta property="og:description" content="Hi everyone, this example should show, how a MCP3208 can be used to read eight analog sources. The MCP3208 is connected to axoloti SPI port. This ADC method is much faster then the 4051 method and the MCP3208 has an input protection. Each ADC channel has a 12bit resolution and is compared to the VREF voltage. VREF should be in a range of 0,25V to VDD and decoupled/stabilized by a 100nF capacitor and min. 10uF polarized capacitor (not shown in the wiring picture). If you want to use more then one..." />
<meta name="twitter:description" content="Hi everyone, this example should show, how a MCP3208 can be used to read eight analog sources. The MCP3208 is connected to axoloti SPI port. This ADC method is much faster then the 4051 method and the MCP3208 has an input protection. Each ADC channel has a 12bit resolution and is compared to the VREF voltage. VREF should be in a range of 0,25V to VDD and decoupled/stabilized by a 100nF capacitor and min. 10uF polarized capacitor (not shown in the wiring picture). If you want to use more then one..." />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="9 mins ðŸ•‘" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="18 â¤" />

      <link rel="next" href="3044658.html?page=2">

  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html"><img src="../../uploads/default/original/1X/b22e6e9ef608f1e17a1de19b733d043beff77f05.png" alt="Axoloti Community" id="site-logo" style="max-width: 150px;"></a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1>
  <a href="304.html">[GPIO I/O] Example ADC MCP3208 &amp; SPI</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/patching.html" itemprop="url">
        <span itemprop="title">Patching</span>
      </a>
    </div>
</div>





<hr>


  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/paul.html'><b itemprop='author'>paul</b></a>
           
           <time datetime='2015-08-23T12:06:48Z' itemprop='datePublished'>
             2015-08-23 12:06:48 UTC
           </time>
        </span>
        <span itemprop='position'>#1</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Hi everyone,<br>this example should show, how a MCP3208 can be used to read eight analog sources. The MCP3208 is connected to axoloti SPI port. This ADC method is much faster then the 4051 method and the MCP3208 has an input protection. Each ADC channel has a 12bit resolution and is compared to the VREF voltage. VREF should be in a range of 0,25V to VDD and decoupled/stabilized by a 100nF capacitor and min. 10uF polarized capacitor (not shown in the wiring picture). If you want to use more then one SPI device, be sure to disable the CS pins of the unused devices. CS Pin can be controlled by axoloti NSS(PA4) or any other digital out GPIO pin.</p>

<p>The bits are send by LSB and read each single analog input channel. By changing the Single/Diff bit (bit 7 of the first byte) you will get the differential between e.g. CH0+ and CH1- etc.. Check page 19 f. of the <a href="http://ww1.microchip.com/downloads/en/DeviceDoc/21298e.pdf" rel="nofollow">MCP3208 datasheet</a>.</p>

<p>Patch: MCP3208 single channel: <br><a class="attachment" href="../../uploads/default/original/1X/mcp3208%20signle%20channel%20example.axp">mcp3208 signle channel example.axp</a> (5.9 KB) <br><a href="http://pastebin.com/E0dPe2zb" rel="nofollow">Script code</a> <br><img src="../../uploads/default/original/1X/d7dc02701aa8cc8e7ce431a9e2476345c377de1b.png" width="559" height="263"> </p>

<p>Wiring (without caps)<br><div class="lightbox-wrapper"><a data-download-href="//community.axoloti.com/uploads/default/4d13396b11275250a45388e12b85fa06fce1b61f" href="../../uploads/default/original/1X/4d13396b11275250a45388e12b85fa06fce1b61f.jpg" class="lightbox" title="MCP3208_web.jpg"><img src="../../uploads/default/optimized/1X/4d13396b11275250a45388e12b85fa06fce1b61f_1_550x500.jpg" width="550" height="500"><div class="meta">
<span class="filename">MCP3208_web.jpg</span><span class="informations">1167x1059 382 KB</span><span class="expand"></span>
</div></a></div> </p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:4'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
            <a href="../how-to-get-a-maximum-of-knobs-on-a-axoloti-core/830.html">How to get a maximum of knobs on a axoloti core?</a>
            <hr>
            <a href="../gpio-i-o-example-4051-de-multiplexer-reads-8-analog-sources/133/32.html">[GPIO I/O] Example 4051 de/multiplexer reads 8 analog sources</a>
            <hr>
            <a href="../adding-more-analog-inputs-using-a-multiplex-breakout-board/3805.html">Adding more analog inputs using a multiplex breakout board</a>
            <hr>
            <a href="../semi-modular-hardware-patch-bay/3962/18.html">Semi-modular hardware patch bay?</a>
            <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/matthewcieplak.html'><b itemprop='author'>matthewcieplak</b></a>
           
           <time datetime='2015-09-22T00:51:46Z' itemprop='datePublished'>
             2015-09-22 00:51:46 UTC
           </time>
        </span>
        <span itemprop='position'>#2</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Thanks for the thorough writeup. I'm trying out this circuit with an MCP3008 and it seems to work pretty well. I don't fully understand the bit about decoupling VREF (and don't have right caps to try it at the moment), but I assume that would mostly improve stability and accuracy of measurement. </p>

<p>I do have a couple questions that you might be able to help me get through. First, the dials always max out at a value of 3.97 (out of 64.00) rather than turning through their full range. Is this a function of the 12-bit depth of the ADC or perhaps my VREF is out of scale? I'm using some 10k pots I had laying around, seemed to work fine in full-range when used on the analog in pins of axoloti.</p>

<p>Second, I'd like to pair this with the <a href="../driving-seven-segment-display-with-mcp23s17-io-expander/index.html">MCP23S17 circuit I've built</a> for my seven-segment display, but it looks like that chip uses MSB-first format and this one LSB-first. Is it possible to run them both simultaneously? (perhaps using 2 spi/config objects?) Or should I find another ADC chip that works on the same SPI format?</p>

<p>Finally, in multi-device configurations, is one digital pad on axoloti needed for each chip in addition to the SPI pads (to manage the chip select on/offs)? I assume the answer is yes, but I'd like to figure out how many pins I'll need on the connector between my control board and axoloti to avoid extra bodge wires. </p>

<p>Thanks again for your clear and cogent demos.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/matthewcieplak.html'><b itemprop='author'>matthewcieplak</b></a>
           
           <time datetime='2015-09-24T06:36:36Z' itemprop='datePublished'>
             2015-09-24 06:36:36 UTC
           </time>
        </span>
        <span itemprop='position'>#3</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>I had a closer look at some of the code used for SPI configuration and it seems like this would be theoretically possible, but maybe not with the provided objects. For example, the gpio/spi/config object initializes a named static "spicfg" constant that would conflict other config objects.<br><aside class="onebox githubblob">
  <header class="source">
    <a href="https://github.com/axoloti/axoloti/blob/master/objects/gpio/spi/config.axo">
      github.com
    </a>
  </header>
  <article class="onebox-body">
    <h4><a href="https://github.com/axoloti/axoloti/blob/master/objects/gpio/spi/config.axo" target="_blank">axoloti/axoloti/blob/master/objects/gpio/spi/config.axo</a></h4>
<pre><code class="lang-axo">&lt;objdefs&gt;
   &lt;obj.normal id="config" uuid="d3e75d8a02e2ccabbbc2af3bc2fcdb8ea65a6133" sha="62af644b09e7f654b36d66533da8ea5971ddb351"&gt;
      &lt;upgradeSha&gt;de87118df6aa11e19d10babb34b404522255b5a3&lt;/upgradeSha&gt;
      &lt;sDescription&gt;Configures a SPI interface. Pin mapping: PA4=NSS PA5=SCK PA6=MISO PA7=MOSI&lt;/sDescription&gt;
      &lt;author&gt;Johannes Taelman&lt;/author&gt;
      &lt;license&gt;BSD&lt;/license&gt;
      &lt;inlets/&gt;
      &lt;outlets/&gt;
      &lt;displays/&gt;
      &lt;params/&gt;
      &lt;attribs&gt;
         &lt;combo name="clock_polarity"&gt;
            &lt;MenuEntries&gt;
               &lt;string&gt;CPOL=0&lt;/string&gt;
               &lt;string&gt;CPOL=1&lt;/string&gt;
            &lt;/MenuEntries&gt;
            &lt;CEntries&gt;
               &lt;string&gt;&lt;/string&gt;
               &lt;string&gt;|SPI_CR1_CPOL&lt;/string&gt;
            &lt;/CEntries&gt;
</code></pre>

  This file has been truncated. <a href="https://github.com/axoloti/axoloti/blob/master/objects/gpio/spi/config.axo" target="_blank">show original</a>

  </article>
  <div style="clear: both"></div>
</aside>
</p>

<p>Nonetheless, ChibiOS does support sequential spiStart() calls with different config objects, according to this thread:<br><a href="http://forum.chibios.org/phpbb/viewtopic.php?f=2&amp;t=676" class="onebox" target="_blank" rel="nofollow">http://forum.chibios.org/phpbb/viewtopic.php?f=2&amp;t=676</a></p>

<p>An example is given as:</p>

<pre><code>if ( SPID1.config != &amp;config1 )   
spiStart(&amp;SPID1, &amp;config1);
spiSelect(&amp;SPID1);
// transfer to device #1
spiUnselect(&amp;SPID1);

// new peripheral
if ( SPID1.config != &amp;config2 )   
spiStart(&amp;SPID1, &amp;config2);
spiSelect(&amp;SPID1);
// transfer to device #2
spiUnselect(&amp;SPID1);</code></pre>

<p>If I have time tomorrow I might hook up both chips and have a quick test to see if doing this manually in a script/object would work.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:1'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/matthewcieplak.html'><b itemprop='author'>matthewcieplak</b></a>
           
           <time datetime='2015-09-28T06:47:09Z' itemprop='datePublished'>
             2015-09-28 06:47:09 UTC
           </time>
        </span>
        <span itemprop='position'>#4</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Talking to myself here, but here's some info for anyone else trying this. I dove into it this evening and determined that it is possible to use multiple SPI devices &amp; formats in the same patch. The built-in gpio/spi/config object instantiates its own configuration, but this can be overridden by creating new SPIConfig objects and calling <code>spiStop(&amp;SPID1)</code> then <code>spiStart(&amp;SPID, &amp;your_config_here)</code>. Here's an abridged version of some working code to read from my MCP3008 and write to the MCP23S17 with this technique. (<em>here be dragons</em>)</p>

<pre><code>uint8_t *txbuf;
uint8_t *rxbuf;
const SPIConfig spicfg_a = {NULL, GPIOA, 4, 3&lt;&lt;3}; //MCP23S17 takes MSB first, uses standard axoloti Chip Select pin PA4
const SPIConfig spicfg_b = {NULL, GPIOA, 0, 3&lt;&lt;3 | SPI_CR1_LSBFIRST}; //MCP3008 takes LSB first, uses extra Chip Select pin PA0


void setup(void){
    spiStop(&amp;SPID1);
    ...
    palSetPadMode(GPIOA,0,PAL_MODE_OUTPUT_PUSHPULL);    // MCP3208
    palWritePad(GPIOA,0,1);                 // pull high to disable first MCP3208
}


void loop(void){
    palWritePad(GPIOA,0,1);        // disable MCP3208
    palWritePad(GPIOA,4,0);        // enable MCP23S17
    spiStop(&amp;SPID1);
    spiStart(&amp;SPID1, &amp;spicfg_a);   // load appropriate config
    spiSelect(&amp;SPID1);
    txbuf[0] = SPI_SLAVE_ID | ((SPI_SLAVE_ADDR &lt;&lt; 1) &amp; 0x0E)| SPI_SLAVE_WRITE;
    txbuf[1] = 0x12;               // gpioa address
    txbuf[2] = 0x01010101;         // binary data for each pin on/off
    spiSend(&amp;SPID1,3, txbuf);  
    spiUnselect(&amp;SPID1);
    palWritePad(GPIOA,4,1);        // disable MCP23S17


    zxbuf[0] = 0b01100000;
    zxbuf[1] = 0b00000000;
    txbuf[2] = 0b00000000;


    palWritePad(GPIOA,0,0);     // enable MCP3208
    spiStop(&amp;SPID1);
    spiStart(&amp;SPID1, &amp;spicfg_b);// load other config
    spiSelect(&amp;SPID1);          // START SPI

    spiSend(&amp;SPID1,3,txbuf);    // send SPI data zxbuf[]
    spiReceive(&amp;SPID1,3,rxbuf); // receive SPI data from MCP3208
    spiUnselect(&amp;SPID1);        // STOP SPI
    palWritePad(GPIOA,0,1);     // disable MCP3208
            
    int z = (rxbuf[1] &lt;&lt; 8| rxbuf[0]) &lt;&lt; 20;

    if (pin == 0){
        PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_c0_value],z,0xFFFD);
    }

    chThdSleepMilliseconds(1);
}</code></pre>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:2'>
      <meta itemprop='interactionCount' content='UserComments:2'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/johannes.html'><b itemprop='author'>johannes</b></a>
           
           <time datetime='2015-09-29T12:30:52Z' itemprop='datePublished'>
             2015-09-29 12:30:52 UTC
           </time>
        </span>
        <span itemprop='position'>#5</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>The SPI slave select signal can probably be shared when the MCP23S17 and MCP3008 have different SPI addresses.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/kaos.html'><b itemprop='author'>kaos</b></a>
           
           <time datetime='2015-12-27T15:34:06Z' itemprop='datePublished'>
             2015-12-27 15:34:06 UTC
           </time>
        </span>
        <span itemprop='position'>#6</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Hi <a class="mention" href="../../users/paul.html">@paul</a>,</p>

<p><strong>wrong wiring diagram, see discussion below for correct diagram</strong></p>

<p>Thanks for the example, and sorry for the noob question:<br>Is this how you would decouple/stabilize an MCP3208? Just got mine in the mail, they're quite pricey, don't want to fry them straight away <img src="../../images/emoji/emoji_one/smilea4f0.png?v=0" title=":smile:" class="emoji" alt=":smile:"> <br>Also is this how you would wire up a pot to CH0?<br><div class="lightbox-wrapper"><a data-download-href="//community.axoloti.com/uploads/default/42fa507aaa8982a2165fbf15395171d2598fa029" href="../../uploads/default/original/2X/4/42fa507aaa8982a2165fbf15395171d2598fa029.png" class="lightbox" title="Screen Shot 2015-12-27 at 16.29.23.png"><img src="../../uploads/default/optimized/2X/4/42fa507aaa8982a2165fbf15395171d2598fa029_1_520x500.png" width="520" height="500"><div class="meta">
<span class="filename">Screen Shot 2015-12-27 at 16.29.23.png</span><span class="informations">1406x1350 244 KB</span><span class="expand"></span>
</div></a></div><br>Also I would like to put another MCP3208 next to this, to get 16 input channels seeing <a class="mention" href="../../users/matthewcieplak.html">@matthewcieplak</a> example, it seems to be possible, but how do I wire it? do they share all but one pin? my bet is the SCK pin is to be connected to another PA pin on the Axoloti...</p>

<p>Thanks!</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:2'>
      <meta itemprop='interactionCount' content='UserComments:3'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/matthewcieplak.html'><b itemprop='author'>matthewcieplak</b></a>
           
           <time datetime='2015-12-27T19:07:06Z' itemprop='datePublished'>
             2015-12-27 19:07:06 UTC
           </time>
        </span>
        <span itemprop='position'>#7</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>The wiring on the potentiometer in your diagram looks fine. The chip will compare the voltage coming in to the input (from the middle pin on the pot) to the voltage coming in from VREF (pin 1 or 2 IIRC). </p>

<p>Your capacitors/decoupling setup looks strange. The small cap is wired in series with the large, and it seems to be bypassed by a jumper. The large cap is between the chip and the VREF, which will block DC altogether (meaning you'll end up with a VREF equal to the leakage of the capacitor, or a few microvolts).</p>

<p>Instead, you should wire your decoupling caps <em>across</em> the positive voltage source and ground. They don't allow current to pass through, so they won't short your system, but they will store a charge that will fill in the gaps or dips in power on your 3.3v source. I wired 3.3v to pins 1 and 2, (PWR and VREF) and ground to 3 and 8 (GND and AGND), and then put a small 100nf (0.1uf) cap directly between pins 2 and 3. You want it to be physically close to the chip as you can get it on the board (within a few cm). I also have a larger 10uf (polarized) capacitor between 3.3v and GND near my input terminal that serves all the chips on the board.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/matthewcieplak.html'><b itemprop='author'>matthewcieplak</b></a>
           
           <time datetime='2015-12-27T19:15:17Z' itemprop='datePublished'>
             2015-12-27 19:15:17 UTC
           </time>
        </span>
        <span itemprop='position'>#8</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>To add an additional MCP3208, it will share all the same connections (3.3v, GND, SCK, MISO, MOSI) except NSS/CS. That stands for "not slave select"/"chip select." So you will need to spare another PA pin from Axoloti (one for each chip basically) as a digital output. Pull it high to disable the chip, low to enable it. Only one CS output should be low at any given time, so you can read the inputs from one chip at a time.</p>

<p>As johannes mentioned, some chips have SPI addressing via bias pins (like the MCP23S17) so you could share the CS pin on up to 8 separate chips, but I don't think that's a feature on MCP3008/3208, so I'd start by separating it.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/paul.html'><b itemprop='author'>paul</b></a>
           
           <time datetime='2015-12-28T09:45:40Z' itemprop='datePublished'>
             2015-12-28 09:45:40 UTC
           </time>
        </span>
        <span itemprop='position'>#9</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>hi kaos, <br>what matthewcieplak writed is right. There is a error at the wiring picture. </p>

<p>If you want more than 8 input by one mcp3208 you can check <a href="http://ucapps.de/mbhp_ainser64.html" rel="nofollow">ucapps AINSER 64 module</a> .<br>It uses a mcp3208, 74hc595 and some 4051 multiplexer. The mcp3208 and 74hc595 use the same NSS/CS pin. I get it working by disconnect the NSS pin of the 74hc595 and connected it to separate NSS pin and powered the AINSER64 it from an external power source.<br>The other DIN and DOUT Moduls are working without any modifications. </p>

<p>It would be great if someone get this Module working with shared NSS pin.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:1'>
      <meta itemprop='interactionCount' content='UserComments:0'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/kaos.html'><b itemprop='author'>kaos</b></a>
           
           <time datetime='2015-12-28T12:36:56Z' itemprop='datePublished'>
             2015-12-28 12:36:56 UTC
           </time>
        </span>
        <span itemprop='position'>#10</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>allright, going for this now. Thanks for the input<br><div class="lightbox-wrapper"><a data-download-href="//community.axoloti.com/uploads/default/fbd4f06033af862c4852537b918922492687c641" href="../../uploads/default/original/2X/f/fbd4f06033af862c4852537b918922492687c641.png" class="lightbox" title="Screen Shot 2015-12-28 at 12.21.38.png"><img src="../../uploads/default/optimized/2X/f/fbd4f06033af862c4852537b918922492687c641_1_640x499.png" width="640" height="499"><div class="meta">
<span class="filename">Screen Shot 2015-12-28 at 12.21.38.png</span><span class="informations">855x667 144 KB</span><span class="expand"></span>
</div></a></div></p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:1'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/kaos.html'><b itemprop='author'>kaos</b></a>
           
           <time datetime='2016-01-19T13:28:07Z' itemprop='datePublished'>
             2016-01-19 13:28:07 UTC
           </time>
        </span>
        <span itemprop='position'>#11</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p><a class="mention" href="../../users/matthewcieplak.html">@matthewcieplak</a>, I did all the soldering as you mentioned and as I described and while it worked for one MCP3208 I'm making some mistake for the second. I think and hope it is on the software side. <a class="mention" href="../../users/paul.html">@paul</a>, your script comment mentions:</p>

<blockquote><p>Connect the MCP3208 CS pin to the NSS(PA4) or any other digital out pin of axoloti.<br>In this example, the MCP3208 CS pin is connected to axoloti B0(GPIOB,0) pin.</p></blockquote>

<p>but in the code I have the feeling you're using different pins</p>

<blockquote><p>palWritePad(GPIOA,0,0);		// enable MCP3208 </p></blockquote>

<p>this is the NSS/CS pin right?</p>

<p>While I'm using the pins labeled PA4 for the first and PA3 for the second one I soldered, My guess is I should use</p>

<blockquote><p>palWritePad(GPIOA,4,0);  </p></blockquote>

<p>to enable the first one and </p>

<blockquote><p>palWritePad(GPIOA,3,0);</p></blockquote>

<p>to enable the second one</p>

<p>the strange thing is, that this worked when I copy-pasted your code using  palWritePad(GPIOA,0,0);<br>This does not make sense as in my opinion, nothing is connected to that pin...</p>

<p>What am I missing?</p>

<p>Kasper</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/kaos.html'><b itemprop='author'>kaos</b></a>
           
           <time datetime='2016-01-19T13:33:10Z' itemprop='datePublished'>
             2016-01-19 13:33:10 UTC
           </time>
        </span>
        <span itemprop='position'>#12</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote" data-post="4" data-topic="304"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/matthewcieplak/40/280_1.html" class="avatar">matthewcieplak:</div>
<blockquote><p>const SPIConfig spicfg_a = {NULL, GPIOA, 4, 3&lt;&lt;3}; //MCP23S17 takes MSB first, uses standard axoloti Chip Select pin PA4<br>const SPIConfig spicfg_b = {NULL, GPIOA, 0, 3&lt;&lt;3 | SPI_CR1_LSBFIRST}; //MCP3008 takes LSB first, uses extra Chip Select pin PA0</p></blockquote></aside>

<p>this was what I was missing.. you need to use the "alternate config" thing</p>

<p>I got it working for one device allready, now I will try it for the second</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/kaos.html'><b itemprop='author'>kaos</b></a>
           
           <time datetime='2016-01-19T19:06:02Z' itemprop='datePublished'>
             2016-01-19 19:06:02 UTC
           </time>
        </span>
        <span itemprop='position'>#13</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Ok I'm hoping this is a software problem. I get accurate readings on 16 pots using 2 MCP3208 if, and here's the catch...</p>

<p>I always get accurate readings from MCP3208 #1, the one connected to axoloti PA4<br>I only get accurate readings from MCP3208 #2, connected to PA3 if the pot on the same pin number on the other MCP3208 is turned to the maximum, otherwise I get some sort of average. If I turn the pot down, I get no reading at all..<br>I'm guessing somewhere in my script I multiply the values, <br>- but I reinitialised the vars,<br>- I increased the sleeptime between polling (thought it was some overflow)<br>- I renamed the z var in the second loop</p>

<p>It took me quite a while to figure out why everything was dancing and then not, I thought it was hardware, so I resoldered a lot of things... apparently for nothing, or not? a bit puzzled.</p>

<p>below is my version of the script</p>

<pre><code>/*
MCP3208 script2 code
by paul
adapted by kaos, this script is not working, there is problem...

Connect the MCP3208 CS pin to the NSS(PA4) or any other digital out pin of axoloti.
In this example, the MCP3208 CS pin is connected to axoloti B0(GPIOB,0) pin.

If you use more then one spi device, it's importent to disable every other spi device by switching their cs pin. 
*/

uint8_t *txbuf;
uint8_t *rxbuf;
const SPIConfig spicfg_a = {NULL, GPIOA, 4, 3&lt;&lt;3  | SPI_CR1_LSBFIRST }; //MCP3208 pin PA4
const SPIConfig spicfg_b = {NULL, GPIOA, 3, 3&lt;&lt;3  | SPI_CR1_LSBFIRST }; //MCP3208 pin PA3




void setup(void){
	static uint8_t _txbuf[8] __attribute__ ((section (".sram2")));
	static uint8_t _rxbuf[8] __attribute__ ((section (".sram2")));
	txbuf = _txbuf;
	rxbuf = _rxbuf;

	palSetPadMode(GPIOA,4,PAL_MODE_OUTPUT_PUSHPULL);	// MCP3208
	palSetPadMode(GPIOA,3,PAL_MODE_OUTPUT_PUSHPULL);	// MCP3208
	//changes
	palWritePad(GPIOA,4,1);								// pull high to disable first MCP3208
	palWritePad(GPIOA,3,1);								// pull high to disable second MCP3208
}

void loop(void){
	// txtbuf[0] = txtbuf[1] = txtbuf[2] = 0b00000000;
   	txbuf[2] = 0b00000000;
 	
    	for(int pin=0; pin&lt;8; pin++){
 
	        txbuf[0] = pin &lt; 4 ? 0b01100000 : 0b11100000;
	 
	        if (pin % 4 == 0) { // pin == 0 || pin == 4
	            txbuf[1] = 0b00000000;
	        } else if (pin % 4 == 1) { // pin == 1 || pin == 5
	            txbuf[1] = 0b00000010;
	        } else if (pin % 4 == 2) { // pin == 2 || pin == 6
	            txbuf[1] = 0b00000001;
	        } else {
	            txbuf[1] = 0b00000011;
	        }
			

		palWritePad(GPIOA,4,0);		// enable MCP3208 #1
		spiSelect(&amp;SPID1);			// START SPI
		spiSend(&amp;SPID1,3,txbuf);	// send SPI data txbuf[]
		spiReceive(&amp;SPID1,3,rxbuf);	// receive SPI data from MCP3208
		spiUnselect(&amp;SPID1);		// STOP SPI
		palWritePad(GPIOA,4,1);		// disable MCP3208 #1
				
		int z = (rxbuf[1] &lt;&lt; 8| rxbuf[0]) &lt;&lt; 16;

		if (pin == 0){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_c0_value],z,0xFFFD);
		}
		else if (pin == 1){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_c1_value],z,0xFFFD); 
		}
		else if (pin == 2){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_c2_value],z,0xFFFD);
		}
		else if (pin == 3){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_c3_value],z,0xFFFD);
		}
		else if (pin == 4){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_c4_value],z,0xFFFD);
		}
		else if (pin == 5){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_c5_value],z,0xFFFD);
		}
		else if (pin == 6){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_c6_value],z,0xFFFD);
		}
		else if (pin == 7){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_c7_value],z,0xFFFD);
		}
	
	}
	chThdSleepMilliseconds(10);
	txbuf[2] = 0b00000000;

	for(int pin=0; pin&lt;8; pin++){
 
	        txbuf[0] = pin &lt; 4 ? 0b01100000 : 0b11100000;
	 
	        if (pin % 4 == 0) { // pin == 0 || pin == 4
	            txbuf[1] = 0b00000000;
	        } else if (pin % 4 == 1) { // pin == 1 || pin == 5
	            txbuf[1] = 0b00000010;
	        } else if (pin % 4 == 2) { // pin == 2 || pin == 6
	            txbuf[1] = 0b00000001;
	        } else {
	            txbuf[1] = 0b00000011;
	        }

		palWritePad(GPIOA,3,0);		// enable MCP3208  #2
		spiSelect(&amp;SPID1);			// START SPI
		spiSend(&amp;SPID1,3,txbuf);	// send SPI data txbuf[]
		spiReceive(&amp;SPID1,3,rxbuf);	// receive SPI data from MCP3208
		spiUnselect(&amp;SPID1);		// STOP SPI
		palWritePad(GPIOA,3,1);		// disable MCP3208 #2
				
		int zz = (rxbuf[1] &lt;&lt; 8| rxbuf[0]) &lt;&lt; 16;

		if (pin == 0){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_d0_value],zz,0xFFFD);
		}
		else if (pin == 1){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_d1_value],zz,0xFFFD); 
		}
		else if (pin == 2){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_d2_value],zz,0xFFFD);
		}
		else if (pin == 3){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_d3_value],zz,0xFFFD);
		}
		else if (pin == 4){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_d4_value],zz,0xFFFD);
		}
		else if (pin == 5){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_d5_value],zz,0xFFFD);
		}
		else if (pin == 6){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_d6_value],zz,0xFFFD);
		}
		else if (pin == 7){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_d7_value],zz,0xFFFD);
		}	
	}
	chThdSleepMilliseconds(10);
}</code></pre>

<p>Kaos</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:2'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/johannes.html'><b itemprop='author'>johannes</b></a>
           
           <time datetime='2016-01-19T19:19:27Z' itemprop='datePublished'>
             2016-01-19 19:19:27 UTC
           </time>
        </span>
        <span itemprop='position'>#14</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote" data-post="13" data-topic="304"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/kaos/40/147_1.png" class="avatar">kaos:</div>
<blockquote><p>I only get accurate readings from MCP3208 #2, connected to PA3 if the pot on the same pin number on the other MCP3208 is turned to the maximum, otherwise I get some sort of average. If I turn the pot down, I get no reading at all..</p></blockquote></aside>

<p>Sounds like #1 is replying too when you try to address only #2, and you get a "bitwise and" of the two pots as a result...<br>Looks like you're not using spicfg_a/spicfg_b configs, and you should...</p>

<p>Let me also suggest to try sending and receiving all channel data in a single spiExchange() call, way more efficient...</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/kaos.html'><b itemprop='author'>kaos</b></a>
           
           <time datetime='2016-01-19T19:32:27Z' itemprop='datePublished'>
             2016-01-19 19:32:27 UTC
           </time>
        </span>
        <span itemprop='position'>#15</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote" data-post="14" data-topic="304"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/johannes/40/8_1.html" class="avatar">johannes:</div>
<blockquote><p>spicfg_a/spicfg_b configs, and you should...</p></blockquote></aside>

<p>I am, in the script it says<br></p>

<aside class="quote" data-post="13" data-topic="304"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/kaos/40/147_1.png" class="avatar">kaos:</div>
<blockquote><p>const SPIConfig spicfg_a = {NULL, GPIOA, 4, 3&lt;&lt;3  | SPI_CR1_LSBFIRST }; //MCP3208 pin PA4<br>const SPIConfig spicfg_b = {NULL, GPIOA, 3, 3&lt;&lt;3  | SPI_CR1_LSBFIRST }; //MCP3208 pin PA3</p></blockquote></aside>

<p>I guess I have to reset the rxbuf somewhere? It just gets copied over<br></p>

<aside class="quote" data-post="13" data-topic="304"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/kaos/40/147_1.png" class="avatar">kaos:</div>
<blockquote><p>int zz = (rxbuf[1] &lt;&lt; 8| rxbuf[0]) &lt;&lt; 16;</p></blockquote></aside>

<p>I'll google the spiExchange, makes sense to me to make it more efficient, not done adding stuff here <img src="../../images/emoji/emoji_one/smilea4f0.png?v=0" title=":smile:" class="emoji" alt=":smile:"></p>

<p>K</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/johannes.html'><b itemprop='author'>johannes</b></a>
           
           <time datetime='2016-01-19T19:37:19Z' itemprop='datePublished'>
             2016-01-19 19:37:19 UTC
           </time>
        </span>
        <span itemprop='position'>#16</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote" data-post="15" data-topic="304"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/kaos/40/147_1.png" class="avatar">kaos:</div>
<blockquote><p>I am</p></blockquote></aside>

<p>err, no, that's only the declaration.<br>spiStart() takes it as an argument.<br>No need to reset rxbuf.</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/kaos.html'><b itemprop='author'>kaos</b></a>
           
           <time datetime='2016-01-19T20:29:19Z' itemprop='datePublished'>
             2016-01-19 20:29:19 UTC
           </time>
        </span>
        <span itemprop='position'>#17</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>right, so I call it in the setup routine as something like this:</p>

<blockquote>
<pre><code>palWritePad(GPIOA,4,0);		// enable MCP3208 #1</code></pre>
<p><strong>&gt;     	spiStart(&amp;spicfg_a);</strong><br>    	spiSelect(&amp;SPID1);			// START SPI<br>    	spiSend(&amp;SPID1,3,txbuf);	// send SPI data txbuf[]<br>    	spiReceive(&amp;SPID1,3,rxbuf);	// receive SPI data from MCP3208<br>    	spiUnselect(&amp;SPID1);		// STOP SPI<br>    	palWritePad(GPIOA,4,1);		// disable MCP3208 #1</p>
</blockquote>

<p>but that fails. looking in the SPI<a href="http://chibios.sourceforge.net/html/group___s_p_i.html#ga6752c9f736f8de774a5bef6dfe2aae2e" rel="nofollow"> Chibios Docs</a> i need to call it as</p>

<pre><code>void spiStart	(	
   SPIDriver * 	spip,
const SPIConfig * 	config 
)</code></pre>

<p> but I have no clue on the SPIdriver, no pointers defined in the example code...</p>

<p>K</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/johannes.html'><b itemprop='author'>johannes</b></a>
           
           <time datetime='2016-01-19T20:33:11Z' itemprop='datePublished'>
             2016-01-19 20:33:11 UTC
           </time>
        </span>
        <span itemprop='position'>#18</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>scroll up a bit here<br><aside class="quote" data-topic="304" data-slug="gpio-i-o-example-adc-mcp3208-spi" data-post="3"><div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="../../user_avatar/community.axoloti.com/matthewcieplak/40/280_1.html" class="avatar">matthewcieplak:</div>
<blockquote><p>I had a closer look at some of the code used for SPI configuration and it seems like this would be theoretically possible, but maybe not with the provided objects. For example, the gpio/spi/config object initializes a named static "spicfg" constant that would conflict other config objects.     Nonetheless, ChibiOS does support sequential spiStart() calls with different config objects, according to this thread: <a href="http://forum.chibios.org/phpbb/viewtopic.php?f=2&amp;t=676" class="onebox" target="_blank" rel="nofollow"></a><a href="http://forum.chibios.org/phpbb/viewtopic.php?f=2&amp;amp;t=676" rel="nofollow">http://forum.chibios.org/phpbb/viewtopic.php?f=2&amp;t=676</a>   An example is given as:   if â€¦</p></blockquote></aside></p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/kaos.html'><b itemprop='author'>kaos</b></a>
           
           <time datetime='2016-01-19T20:42:56Z' itemprop='datePublished'>
             2016-01-19 20:42:56 UTC
           </time>
        </span>
        <span itemprop='position'>#19</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>OK it works!</p>

<p><code>&gt; spiStart(&amp;SPID1, &amp;spicfg_b);</code></p>

<p>16 pots using only 5 pins...optimising will be for some other time!<br>onto the next challenge <img src="../../images/emoji/emoji_one/smilea4f0.png?v=0" title=":smile:" class="emoji" alt=":smile:"></p>

<p>Thanks!</p>

<pre><code>/*
MCP3208 script2 code
by paul
adapted by kaos, this script is not optimized, but it works!
Connect the MCP3208 CS pin to the NSS(PA4) or any other digital out pin of axoloti.
In this example, the MCP3208 CS pin is connected to axoloti B0(GPIOB,0) pin.

If you use more then one spi device, it's importent to disable every other spi device by switching their cs pin. 
*/

uint8_t *txbuf;
uint8_t *rxbuf;
const SPIConfig spicfg_a = {NULL, GPIOA, 4, 3&lt;&lt;3  | SPI_CR1_LSBFIRST }; //MCP3208 pin PA4
const SPIConfig spicfg_b = {NULL, GPIOA, 3, 3&lt;&lt;3  | SPI_CR1_LSBFIRST }; //MCP3208 pin PA3




void setup(void){
	static uint8_t _txbuf[8] __attribute__ ((section (".sram2")));
	static uint8_t _rxbuf[8] __attribute__ ((section (".sram2")));
	txbuf = _txbuf;
	rxbuf = _rxbuf;

	palSetPadMode(GPIOA,4,PAL_MODE_OUTPUT_PUSHPULL);	// MCP3208
	palSetPadMode(GPIOA,3,PAL_MODE_OUTPUT_PUSHPULL);	// MCP3208
	//changes
	palWritePad(GPIOA,4,1);								// pull high to disable first MCP3208
	palWritePad(GPIOA,3,1);								// pull high to disable second MCP3208
}

void loop(void){
	// txtbuf[0] = txtbuf[1] = txtbuf[2] = 0b00000000;
   	txbuf[2] = 0b00000000;
 	
    	for(int pin=0; pin&lt;8; pin++){
 
	        txbuf[0] = pin &lt; 4 ? 0b01100000 : 0b11100000;
	 
	        if (pin % 4 == 0) { // pin == 0 || pin == 4
	            txbuf[1] = 0b00000000;
	        } else if (pin % 4 == 1) { // pin == 1 || pin == 5
	            txbuf[1] = 0b00000010;
	        } else if (pin % 4 == 2) { // pin == 2 || pin == 6
	            txbuf[1] = 0b00000001;
	        } else {
	            txbuf[1] = 0b00000011;
	        }
			

		palWritePad(GPIOA,4,0);		// enable MCP3208 #1
		spiStart(&amp;SPID1, &amp;spicfg_a);
		spiSelect(&amp;SPID1);			// START SPI
		spiSend(&amp;SPID1,3,txbuf);	// send SPI data txbuf[]
		spiReceive(&amp;SPID1,3,rxbuf);	// receive SPI data from MCP3208
		spiUnselect(&amp;SPID1);		// STOP SPI
		palWritePad(GPIOA,4,1);		// disable MCP3208 #1
				
		int z = (rxbuf[1] &lt;&lt; 8| rxbuf[0]) &lt;&lt; 16;

		if (pin == 0){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_c0_value],z,0xFFFD);
		}
		else if (pin == 1){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_c1_value],z,0xFFFD); 
		}
		else if (pin == 2){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_c2_value],z,0xFFFD);
		}
		else if (pin == 3){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_c3_value],z,0xFFFD);
		}
		else if (pin == 4){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_c4_value],z,0xFFFD);
		}
		else if (pin == 5){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_c5_value],z,0xFFFD);
		}
		else if (pin == 6){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_c6_value],z,0xFFFD);
		}
		else if (pin == 7){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_c7_value],z,0xFFFD);
		}
	
	}
	chThdSleepMilliseconds(10);
	txbuf[2] = 0b00000000;

	for(int pin=0; pin&lt;8; pin++){
 
	        txbuf[0] = pin &lt; 4 ? 0b01100000 : 0b11100000;
	 
	        if (pin % 4 == 0) { // pin == 0 || pin == 4
	            txbuf[1] = 0b00000000;
	        } else if (pin % 4 == 1) { // pin == 1 || pin == 5
	            txbuf[1] = 0b00000010;
	        } else if (pin % 4 == 2) { // pin == 2 || pin == 6
	            txbuf[1] = 0b00000001;
	        } else {
	            txbuf[1] = 0b00000011;
	        }

		palWritePad(GPIOA,3,0);		// enable MCP3208  #2
		spiStart(&amp;SPID1, &amp;spicfg_b);
		spiSelect(&amp;SPID1);			// START SPI
		spiSend(&amp;SPID1,3,txbuf);	// send SPI data txbuf[]
		spiReceive(&amp;SPID1,3,rxbuf);	// receive SPI data from MCP3208
		spiUnselect(&amp;SPID1);		// STOP SPI
		palWritePad(GPIOA,3,1);		// disable MCP3208 #2
				
		int zz = (rxbuf[1] &lt;&lt; 8| rxbuf[0]) &lt;&lt; 16;

		if (pin == 0){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_d0_value],zz,0xFFFD);
		}
		else if (pin == 1){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_d1_value],zz,0xFFFD); 
		}
		else if (pin == 2){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_d2_value],zz,0xFFFD);
		}
		else if (pin == 3){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_d3_value],zz,0xFFFD);
		}
		else if (pin == 4){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_d4_value],zz,0xFFFD);
		}
		else if (pin == 5){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_d5_value],zz,0xFFFD);
		}
		else if (pin == 6){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_d6_value],zz,0xFFFD);
		}
		else if (pin == 7){
			PExParameterChange(&amp;parent-&gt;PExch[PARAM_INDEX_d7_value],zz,0xFFFD);
		}	
	}
	chThdSleepMilliseconds(10);
}</code></pre>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:5'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting'>
      <div class='creator'>
        <span>
          <a href='../../u/gagarin.html'><b itemprop='author'>gagarin</b></a>
           
           <time datetime='2016-09-14T07:00:34Z' itemprop='datePublished'>
             2016-09-14 07:00:34 UTC
           </time>
        </span>
        <span itemprop='position'>#20</span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>How many MCP3208 devices is possible to use with axoloti or what is the max number of pots is posible to connect to axoloti using mcp chips? Do they intorduce aditional cpu load?</p>
      </div>
      <meta itemprop='interactionCount' content='UserLikes:0'>
      <meta itemprop='interactionCount' content='UserComments:1'>
      <meta itemprop='headline' content='[GPIO I/O] Example ADC MCP3208 &amp; SPI'>
      <hr>
  </div>

  <div role='navigation' itemscope itemtype='http://schema.org/SiteNavigationElement'>
      <span itemprop='url'><b><a rel="next" itemprop="name" href="3044658.html?page=2">next page â†’</a></b></span>
  </div>





    </div>
    <footer class="container">
      <nav itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <a href='../../index.html'>Home</a>
        <a href="../../categories.html">Categories</a>
        <a href="../../guidelines.html">FAQ/Guidelines</a>
        <a href="../../tos.html">Terms of Service</a>
        <a href="../../privacy.html">Privacy Policy</a>
      </nav>
      <p>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
    
  </body>
  

<!-- Mirrored from community.axoloti.com/t/gpio-i-o-example-adc-mcp3208-spi/304?source_topic_id=3962 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 10 Jul 2023 17:17:22 GMT -->
</html>
